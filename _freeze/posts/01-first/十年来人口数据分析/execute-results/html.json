{
  "hash": "eb07301e262ed89c17d972e0206f735d",
  "result": {
    "markdown": "---\ntitle: \"人口数据\"\ndraft: true\n---\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(ggrepel)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n\n# 数据清洗\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_rate <- read_csv(\"data/出生率死亡率自然增长率.csv\",\n                    locale = locale(encoding = \"GBK\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nRows: 3 Columns: 10\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (1): 指标\ndbl (9): 2022年, 2021年, 2020年, 2019年, 2018年, 2017年, 2016年, 2015年, 2014年\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n:::\n\n```{.r .cell-code}\ndt_rate <- dt_rate %>% \n  pivot_longer(\n    cols = - 指标,\n    names_to = \"year\"\n  ) %>% \n  pivot_wider(\n    names_from = 指标\n  ) %>% \n  mutate(year = parse_number(year))\ndt_rate\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 9 × 4\n   year `人口出生率(‰)` `人口死亡率(‰)` `人口自然增长率(‰)`\n  <dbl>           <dbl>           <dbl>               <dbl>\n1  2022            6.77            7.37               -0.6 \n2  2021            7.52            7.18                0.34\n3  2020            8.52            7.07                1.45\n4  2019           10.4             7.09                3.32\n5  2018           10.9             7.08                3.78\n6  2017           12.6             7.06                5.58\n7  2016           13.6             7.04                6.53\n8  2015           12.0             7.07                4.93\n9  2014           13.8             7.12                6.71\n```\n:::\n:::\n\n\n\n其他数据集和该数据集情况类似，可以写个函数批量\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nread_pivot <- function(file) {\n  read_csv(file, locale = locale(encoding = \"GBK\")) %>% \n    pivot_longer(\n    cols = - 指标,\n    names_to = \"year\"\n  ) %>% \n  pivot_wider(\n    names_from = 指标\n  ) %>% \n  mutate(year = parse_number(year))\n}\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nfiles <- fs::dir_ls(\"data\")\nfile_names <- str_c(\"dt_\", c(\"age_dist\", \"rate\", \"education\", \"female\", \"marriage\", \"age\", \"gender\", \"population\", \"male\"))\nbind_cols(files, file_names)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nNew names:\n• `` -> `...1`\n• `` -> `...2`\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 9 × 2\n  ...1                            ...2         \n  <fs::path>                      <chr>        \n1 data/人口年龄分布.csv           dt_age_dist  \n2 data/出生率死亡率自然增长率.csv dt_rate      \n3 data/受教育程度.csv             dt_education \n4 data/女性年龄分布.csv           dt_female    \n5 data/婚姻状况.csv               dt_marriage  \n6 data/年龄结构.csv               dt_age       \n7 data/性别比.csv                 dt_gender    \n8 data/总人口.csv                 dt_population\n9 data/男性年龄分布.csv           dt_male      \n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list <- map(files, read_pivot)\ndt_list <- set_names(dt_list, file_names)\ndt_list[1]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$dt_age_dist\n# A tibble: 10 × 22\n    year 人口数(人口抽样调查)(人…¹ 0-4岁人口数(人口抽样…² 5-9岁人口数(人口抽样…³\n   <dbl>                     <dbl>                  <dbl>                  <dbl>\n 1  2023                        NA                     NA                     NA\n 2  2022                   1443996                  62248                  90793\n 3  2021                   1494054                  72978                  96094\n 4  2020                        NA                     NA                     NA\n 5  2019                   1091876                  62722                  60701\n 6  2018                   1144648                  67393                  63322\n 7  2017                   1145246                  68313                  63314\n 8  2016                   1158019                  68447                  63831\n 9  2015                  21312241                1243566                1174724\n10  2014                   1124402                  63990                  63132\n# ℹ abbreviated names: ¹​`人口数(人口抽样调查)(人)`,\n#   ²​`0-4岁人口数(人口抽样调查)(人)`, ³​`5-9岁人口数(人口抽样调查)(人)`\n# ℹ 18 more variables: `10-14岁人口数(人口抽样调查)(人)` <dbl>,\n#   `15-19岁人口数(人口抽样调查)(人)` <dbl>,\n#   `20-24岁人口数(人口抽样调查)(人)` <dbl>,\n#   `25-29岁人口数(人口抽样调查)(人)` <dbl>,\n#   `30-34岁人口数(人口抽样调查)(人)` <dbl>, …\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_age_dist <- dt_list$dt_age_dist %>% \n  pivot_longer(\n    cols = - c(year, `人口数(人口抽样调查)(人)`),\n    names_to = \"年龄段\",\n    values_to = \"人口数\"\n  ) %>% \n  mutate(`年龄段` = str_remove(`年龄段`, \"人口数.+\")) %>% \n  rename(`总人口数` = `人口数(人口抽样调查)(人)`)\n\ndt_list$dt_age_dist\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 200 × 4\n    year 总人口数 年龄段  人口数\n   <dbl>    <dbl> <chr>    <dbl>\n 1  2023       NA 0-4岁       NA\n 2  2023       NA 5-9岁       NA\n 3  2023       NA 10-14岁     NA\n 4  2023       NA 15-19岁     NA\n 5  2023       NA 20-24岁     NA\n 6  2023       NA 25-29岁     NA\n 7  2023       NA 30-34岁     NA\n 8  2023       NA 35-39岁     NA\n 9  2023       NA 40-44岁     NA\n10  2023       NA 45-49岁     NA\n# ℹ 190 more rows\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_rate <- dt_list$dt_rate %>% \n  pivot_longer(\n    cols = -year,\n    names_to = \"比率名称\",\n    names_pattern = \"人口([^\\\\(]+)\",\n    values_to = \"比值\"\n  )\ndt_list$dt_rate\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 27 × 3\n    year 比率名称    比值\n   <dbl> <chr>      <dbl>\n 1  2022 出生率      6.77\n 2  2022 死亡率      7.37\n 3  2022 自然增长率 -0.6 \n 4  2021 出生率      7.52\n 5  2021 死亡率      7.18\n 6  2021 自然增长率  0.34\n 7  2020 出生率      8.52\n 8  2020 死亡率      7.07\n 9  2020 自然增长率  1.45\n10  2019 出生率     10.4 \n# ℹ 17 more rows\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_education <- dt_list$dt_education %>% \n  select(-matches(\"[^性]人口数|6岁及6岁以上.性\")) %>% \n  pivot_longer(\n    cols = -year,\n    values_to = \"人口数\",\n    names_to = c(\"教育程度\", \"性别\"),\n    names_pattern = \"6岁及6岁以上([^男|女]+)(男性|女性)人口数\\\\(人口抽样调查\\\\)\\\\(人\\\\)\"\n  )\n\n\ndt_list$dt_education\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 170 × 4\n    year 教育程度   性别  人口数\n   <dbl> <chr>      <chr>  <dbl>\n 1  2022 未上过学   男性   14948\n 2  2022 未上过学   女性   36444\n 3  2022 小学       男性  167013\n 4  2022 小学       女性  188341\n 5  2022 初中       男性  252064\n 6  2022 初中       女性  215929\n 7  2022 高中       男性  123426\n 8  2022 高中       女性   99455\n 9  2022 大专及以上 男性  137692\n10  2022 大专及以上 女性  127723\n# ℹ 160 more rows\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_female <- dt_list$dt_female %>% \n  select(-`女性人口数(人口抽样调查)(人)`) %>% \n  pivot_longer(\n    cols = -year,\n    names_to = c(\"年龄段\", \"性别\"),\n    names_pattern = \"([^女]+)(女性)\",\n    values_to = \"人口数\"\n  )\n  \ndt_list$dt_female\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 160 × 4\n    year 年龄段  性别  人口数\n   <dbl> <chr>   <chr>  <dbl>\n 1  2022 0-4岁   女性   29658\n 2  2022 5-9岁   女性   42783\n 3  2022 10-14岁 女性   42781\n 4  2022 15-19岁 女性   36873\n 5  2022 20-24岁 女性   34483\n 6  2022 25-29岁 女性   40234\n 7  2022 30-34岁 女性   56267\n 8  2022 35-39岁 女性   53435\n 9  2022 40-44岁 女性   47957\n10  2022 45-49岁 女性   51025\n# ℹ 150 more rows\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_male <- dt_list$dt_male %>% \n  select(-`男性人口数(人口抽样调查)(人)`) %>% \n  pivot_longer(\n    cols = -year,\n    names_to = c(\"年龄段\", \"性别\"),\n    names_pattern = \"([^男]+)(男性)\",\n    values_to = \"人口数\"\n  )\ndt_list$dt_male\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 160 × 4\n    year 年龄段  性别  人口数\n   <dbl> <chr>   <chr>  <dbl>\n 1  2022 0-4岁   男性   32589\n 2  2022 5-9岁   男性   48010\n 3  2022 10-14岁 男性   49065\n 4  2022 15-19岁 男性   42687\n 5  2022 20-24岁 男性   39146\n 6  2022 25-29岁 男性   44806\n 7  2022 30-34岁 男性   60488\n 8  2022 35-39岁 男性   56397\n 9  2022 40-44岁 男性   50422\n10  2022 45-49岁 男性   52930\n# ℹ 150 more rows\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_gender <- dt_list$dt_gender %>% \n  pivot_longer(\n    cols = -c(year, `性别比(女=100)(人口抽样调查)`),\n    names_to = \"年龄段\",\n    names_pattern = \"([^性]+)\",\n    values_to = \"性别比\"\n  ) %>% \n  rename(总体性别比 = `性别比(女=100)(人口抽样调查)`)\ndt_list$dt_gender\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 160 × 4\n    year 总体性别比 年龄段  性别比\n   <dbl>      <dbl> <chr>    <dbl>\n 1  2022       104. 0-4岁     110.\n 2  2022       104. 5-9岁     112.\n 3  2022       104. 10-14岁   115.\n 4  2022       104. 15-19岁   116.\n 5  2022       104. 20-24岁   114.\n 6  2022       104. 25-29岁   111.\n 7  2022       104. 30-34岁   108.\n 8  2022       104. 35-39岁   106.\n 9  2022       104. 40-44岁   105.\n10  2022       104. 45-49岁   104.\n# ℹ 150 more rows\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_population <- dt_list$dt_population %>% \n  pivot_longer(\n    cols = - c(year, `年末总人口(万人)`),\n    names_to = \"类别\",\n    names_pattern = \"([^人]+)\",\n    values_to = \"人口数_万人\"\n  ) %>% \n  rename(总人口_万人 = `年末总人口(万人)`)\ndt_list$dt_population\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 36 × 4\n    year 总人口_万人 类别  人口数_万人\n   <dbl>       <dbl> <chr>       <dbl>\n 1  2022      141175 男性        72206\n 2  2022      141175 女性        68969\n 3  2022      141175 城镇        92071\n 4  2022      141175 乡村        49104\n 5  2021      141260 男性        72311\n 6  2021      141260 女性        68949\n 7  2021      141260 城镇        91425\n 8  2021      141260 乡村        49835\n 9  2020      141212 男性        72357\n10  2020      141212 女性        68855\n# ℹ 26 more rows\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_age <- dt_list$dt_age %>% \n  pivot_longer(\n    cols = - c(year, `年末总人口(万人)`, contains(\"抚养比\")),\n    names_to = \"年龄段\",\n    names_pattern = \"([^人]+)\",\n    values_to = \"人口_万人\"\n  ) %>% \n  mutate(抚养比 = case_when(\n    年龄段 == \"0-14岁\" ~ `少儿抚养比(%)`,\n    年龄段 == \"65岁及以上\" ~ `老年抚养比(%)`,\n    TRUE ~ NA\n  )) %>% \n  select(-`少儿抚养比(%)`, -`老年抚养比(%)`)\n\ndt_list$dt_age\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 27 × 6\n    year `年末总人口(万人)` `总抚养比(%)` 年龄段     人口_万人 抚养比\n   <dbl>              <dbl>         <dbl> <chr>          <dbl>  <dbl>\n 1  2022             141175          46.6 0-14岁         23908   24.8\n 2  2022             141175          46.6 15-64岁        96289   NA  \n 3  2022             141175          46.6 65岁及以上     20978   21.8\n 4  2021             141260          46.3 0-14岁         24678   25.6\n 5  2021             141260          46.3 15-64岁        96526   NA  \n 6  2021             141260          46.3 65岁及以上     20056   20.8\n 7  2020             141212          45.9 0-14岁         25277   26.2\n 8  2020             141212          45.9 15-64岁        96871   NA  \n 9  2020             141212          45.9 65岁及以上     19064   19.7\n10  2019             141008          41.5 0-14岁         23689   23.8\n# ℹ 17 more rows\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_marriage %>% \n  mutate(across(-year, is.na)) %>% \n  pivot_longer(cols = -year) %>% \n  mutate(name = fct(name, levels = colnames(dt_list$dt_marriage))) %>% \n  ggplot(aes(x = year, y = fct_rev(name), fill = value)) +\n  geom_tile() +\n  scale_fill_brewer(palette = \"Paired\", direction = -1,\n                    limits = c(FALSE, TRUE), labels = c(\"存在\", \"缺失\")) +\n  theme(legend.position = \"top\") +\n  coord_equal(xlim = c(2003.5, 2023.5), expand = FALSE) +\n  labs(x = \"年份\", y = \"类别\", fill = \"数据是否存在\")\n```\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-15-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n由上图可知，和配偶相关的数据在2015年以后被整合为`有配偶人数`、`男性有配偶人数`和`女性有配偶人数`\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_marriage <- dt_list$dt_marriage %>% \n  mutate(`15岁及以上男性有配偶人口数(人口抽样调查)(人)` = rowSums(pick(matches(\"男性.*有配偶\")), na.rm = TRUE),\n         `15岁及以上女性有配偶人口数(人口抽样调查)(人)` = rowSums(pick(matches(\"女性.*有配偶\")), na.rm = TRUE),\n         `15岁及以上有配偶人口数(人口抽样调查)(人)` = `15岁及以上男性有配偶人口数(人口抽样调查)(人)` + `15岁及以上女性有配偶人口数(人口抽样调查)(人)`) %>% \n  select(-matches(\"婚有配偶\")) %>% \n  mutate(across(everything(), \\(x) if_else(x == 0, NA, x)))\n\n\ndt_list$dt_marriage %>% \n  mutate(across(-year, is.na)) %>% \n  pivot_longer(cols = -year) %>% \n  mutate(name = fct(name, levels = colnames(dt_list$dt_marriage))) %>% \n  ggplot(aes(x = year, y = fct_rev(name), fill = value)) +\n  geom_tile() +\n  scale_fill_brewer(palette = \"Paired\", direction = -1,\n                    limits = c(FALSE, TRUE), labels = c(\"存在\", \"缺失\")) +\n  labs(fill = \"数据是否存在\") +\n  theme(legend.position = \"top\") +\n  coord_equal(xlim = c(2003.5, 2023.5), expand = FALSE) +\n  labs(x = \"年份\", y = \"类别\")\n```\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-16-1.png){fig-align='center' width=80%}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_marriage <- dt_list$dt_marriage %>% \n  select(year, contains(\"性\"), - `15岁及以上男性人口数(人口抽样调查)(人)`, - `15岁及以上女性人口数(人口抽样调查)(人)`) %>% \n  pivot_longer(\n    cols = - year,\n    names_to = c(\"性别\", \"婚姻状况\"),\n    names_pattern = \"15岁及以上(.性)([^人]+)\",\n    values_to = \"人口数\"\n  )\n```\n:::\n\n\n\n# 数据可视化\n\n\n## 总人口\n\n十年来人口趋势\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np_pop_gen_1 <- dt_list$dt_population %>% \n  filter(str_detect(类别, \"性\")) %>% \n  ggplot(aes(x = year, y = 人口数_万人, color = 类别)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_comma()) +\n  labs(x = \"年份\", y = \"人口数(万人)\")\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np_pop_gen_2 <- dt_list$dt_population %>% \n  mutate(所占比例 = 人口数_万人 / 总人口_万人) %>% \n  filter(str_detect(类别, \"性\")) %>% \n  ggplot(aes(x = year, y = 所占比例, color = 类别)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_percent(), limits = c(0.425, 0.575)) +\n  labs(x = \"年份\")\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(patchwork)\np_pop_gen_1 / p_pop_gen_2 +\n plot_layout(guides = \"collect\") +\n  plot_annotation(title = \"2014 - 2022 男女人口趋势\")&\n  scale_color_viridis_d(option = \"C\", end = 0.5)\n```\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-20-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n男女人口数量的上升趋于平缓，而男女的比例大致不变\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np_pop_city_1 <- dt_list$dt_population %>% \n  filter(!str_detect(类别, \"性\")) %>% \n  ggplot(aes(x = year, y = 人口数_万人, color = 类别)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_comma()) +\n  labs(x = \"年份\", y = \"人口数(万人)\")\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np_pop_city_2 <- dt_list$dt_population %>% \n  mutate(所占比例 = 人口数_万人 / 总人口_万人) %>% \n  filter(!str_detect(类别, \"性\")) %>% \n  ggplot(aes(x = year, y = 所占比例, color = 类别)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_percent(), limits = c(0.25, 0.75)) +\n  labs(x = \"年份\")\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np_pop_city_1 / p_pop_city_2 +\n  plot_layout(guides = \"collect\") +\n  plot_annotation(title = \"2014 - 2022 城乡人口变化\") &\n  scale_color_viridis_d(option = \"C\", end = 0.5)\n```\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-23-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n农村人口不断流向城市\n\n## 出生率死亡率自然增长率\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_rate %>% \n  mutate(alpha = if_else(比率名称 == \"死亡率\", 0.25, 1)) %>% \n  ggplot(aes(x = year, y = 比值/100, color = 比率名称, alpha = alpha)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  scale_alpha(range = c(0.25, 1)) +\n  scale_color_viridis_d(option = \"C\", end = 0.5) +\n  labs(y = \"比值\", x = \"年份\", title = \"2014 - 2022 \\n人口出生率、死亡率、自然增长率\") +\n  guides(alpha = \"none\") \n```\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-24-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n需要把颜色或者透明度调一调\n\n死亡率基本持平而，自然增长率的下降主要是由于出生率的下降而导致的\n\n\n## 年龄结构\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\np_age_1 <- dt_list$dt_age %>% \n  ggplot(aes(year, 人口_万人, color = 年龄段)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_comma()) +\n  labs(y = \"人口（万人）\")\n\n\np_age_2 <- dt_list$dt_age %>% \n  # filter(!is.na(抚养比)) %>% \n  ggplot(aes(year, 抚养比/100, color = 年龄段)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  #scale_color_discrete(breaks = c(\"0-14岁\", \"65岁及以上\")) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  labs(y = \"抚养比\")\n\np_age_1 / p_age_2 +\n  plot_annotation(title = \"2014-2022 年龄结构\") +\n  plot_layout(guides = \"collect\") &\n  scale_color_viridis_d(option = \"C\", end = 0.5)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 9 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 9 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n:::\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-25-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## 人口年龄分布\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_age_dist %>% \n  ggplot(aes(x = year, y = 总人口数)) +\n  geom_line(linewidth = 2, col = \"#A52A2A\") +\n  geom_point(size = 4, col = \"#A52A2A\") +\n  scale_y_continuous(labels = scales::label_comma()) +\n  labs(x = \"年份\", y = \"样本量\", title = \"2014-2022 样本量\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 20 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 40 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n:::\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-26-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n该数据是抽样数据，且2015年所抽查的样本数量远高于其他年份，因此采用比例数据代替原有数据\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_age_dist %>% \n  mutate(占总人口比例 = 人口数 / 总人口数) %>% \n  ggplot(aes(x = 年龄段, y = 占总人口比例, fill = 年龄段)) +\n  geom_col() +\n  facet_wrap(vars(year), nrow = 2) +\n  scale_fill_viridis_d(option = \"C\") +\n  scale_x_discrete(breaks = c(\"0-4岁\", \"75-79岁\")) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  guides(fill = \"none\") +\n  theme(axis.text.x = element_text(angle = - 45)) +\n  labs(title = \"2014-2022 人口年龄分布\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 40 rows containing missing values or values outside the scale range\n(`geom_col()`).\n```\n:::\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-27-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n人口结构呈现出纺锤型，还未变为倒金字塔型\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_age_dist %>% \n  mutate(占总人口比例 = 人口数 / 总人口数,\n         age_num = as.integer(str_extract(年龄段, \"[^-|岁]+\"))) %>% \n  arrange(year) %>% \n  mutate(first_ob = first(占总人口比例),\n         last_ob = nth(占总人口比例, -2),\n         .by = 年龄段) %>% \n  mutate(alpha = if_else(last_ob - first_ob < 0, 1, 0.7)) %>% \n  mutate(label = if_else(year == 2022 & alpha == 1, 年龄段, NA),\n         label_y = if_else(!is.na(label), 占总人口比例, NA)) %>% \n  ggplot(aes(x = year, y = 占总人口比例, color = age_num, group = age_num, alpha = alpha)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  geom_label_repel(aes(x = 2022, y = label_y, label = label), nudge_x = 2.2, nudge_y = 0.015, seed = 123) +\n  labs(color = \"年龄段\") +\n  scale_color_viridis_c(option = \"C\", breaks = c(0, 25, 50, 75), labels = c(\"0-4岁\", \"25-29岁\", \"50-54岁\", \"75-79岁\")) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  scale_alpha_continuous(range = c(0.3, 1)) +\n  guides(alpha = \"none\") +\n  labs(x = \"年份\", title = \"2014-2022 年龄分布变化\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 20 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 40 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 193 rows containing missing values or values outside the scale range\n(`geom_label_repel()`).\n```\n:::\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-28-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n\n可以看出与十年前相比，年轻人在总人口中所占的比例不断下降\n\n\n## 男性年龄分布与女性年龄分布\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_gender <- dt_list$dt_male %>% \n  bind_rows(dt_list$dt_female) \n\ndt_gender <- dt_list$dt_age_dist %>% \n  rename(该年龄段总人数 = 人口数) %>%\n  left_join(dt_gender, join_by(year, 年龄段)) %>% \n  mutate(该性别总人数 = sum(人口数), .by = c(year, 性别)) %>% \n  relocate(year, 年龄段, 性别, 人口数, 该性别总人数, 该年龄段总人数)\n\ndt_gender\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 360 × 7\n    year 年龄段  性别  人口数 该性别总人数 该年龄段总人数 总人口数\n   <dbl> <chr>   <chr>  <dbl>        <dbl>          <dbl>    <dbl>\n 1  2023 0-4岁   <NA>      NA           NA             NA       NA\n 2  2023 5-9岁   <NA>      NA           NA             NA       NA\n 3  2023 10-14岁 <NA>      NA           NA             NA       NA\n 4  2023 15-19岁 <NA>      NA           NA             NA       NA\n 5  2023 20-24岁 <NA>      NA           NA             NA       NA\n 6  2023 25-29岁 <NA>      NA           NA             NA       NA\n 7  2023 30-34岁 <NA>      NA           NA             NA       NA\n 8  2023 35-39岁 <NA>      NA           NA             NA       NA\n 9  2023 40-44岁 <NA>      NA           NA             NA       NA\n10  2023 45-49岁 <NA>      NA           NA             NA       NA\n# ℹ 350 more rows\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_gender %>% \n  filter(!is.na(性别)) %>% \n  mutate(占该性别总人口数的比例 = 人口数 / 该性别总人数) %>% \n  ggplot(aes(x = 年龄段, y = 占该性别总人口数的比例, fill = 年龄段)) +\n  geom_col() +\n  facet_grid(性别 ~ year) +\n  scale_fill_viridis_d(option = \"C\") +\n  scale_x_discrete(breaks = c(\"0-4岁\", \"75-79岁\")) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  guides(fill = \"none\") +\n  theme(axis.text.x = element_text(angle = -45)) +\n  labs(title = \"2014-2022 男女年龄分布\")\n```\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-30-1.png){fig-align='center' width=80%}\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_gender %>% \n  filter(!is.na(性别)) %>% \n  mutate(占该性别总人口数的比例 = 人口数 / 该性别总人数,\n         age_num = as.integer(str_extract(年龄段, \"[^-|岁]+\"))) %>% \n  arrange(year) %>% \n  mutate(first_ob = first(占该性别总人口数的比例),\n         last_ob = nth(占该性别总人口数的比例, -2),\n         .by = 年龄段) %>% \n  mutate(alpha = if_else(last_ob - first_ob < 0, 1, 0.7)) %>% \n  mutate(label = if_else(year == 2022 & alpha == 1, 年龄段, NA),\n         label_y = if_else(!is.na(label), 占该性别总人口数的比例, NA)) %>% \n  ggplot(aes(x = year, y = 占该性别总人口数的比例, color = age_num, group = age_num, alpha = alpha)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  geom_label_repel(aes(x = 2022, y = label_y, label = label), nudge_x = 2.2, nudge_y = 0.015, seed = 123) +\n  labs(color = \"年龄段\") +\n  facet_wrap(vars(性别), nrow = 1) +\n  scale_color_viridis_c(option = \"C\", breaks = c(0, 25, 50, 75), labels = c(\"0-4岁\", \"25-29岁\", \"50-54岁\", \"75-79岁\")) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  scale_alpha_continuous(range = c(0.3, 1)) +\n  guides(alpha = \"none\")  +\n  theme(legend.position = \"bottom\", \n        legend.key.width = unit(35, \"pt\")) +\n  labs(title = \"2014-2022 男女年龄分布变化\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 306 rows containing missing values or values outside the scale range\n(`geom_label_repel()`).\n```\n:::\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-31-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n## 性别比\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_gender\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 160 × 4\n    year 总体性别比 年龄段  性别比\n   <dbl>      <dbl> <chr>    <dbl>\n 1  2022       104. 0-4岁     110.\n 2  2022       104. 5-9岁     112.\n 3  2022       104. 10-14岁   115.\n 4  2022       104. 15-19岁   116.\n 5  2022       104. 20-24岁   114.\n 6  2022       104. 25-29岁   111.\n 7  2022       104. 30-34岁   108.\n 8  2022       104. 35-39岁   106.\n 9  2022       104. 40-44岁   105.\n10  2022       104. 45-49岁   104.\n# ℹ 150 more rows\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_gender %>% \n  mutate(age_num = as.integer(str_extract(年龄段, \"[^-|岁]+\"))) %>% \n  ggplot(aes(year, 性别比/100 , color = age_num, group = age_num)) +\n  geom_line(linewidth = 2, alpha = 0.4) +\n  geom_point(size = 4, alpha = 0.4) +\n  geom_line(aes(year, 总体性别比/100), color = 'steelblue',\n            linewidth = 2) +\n  geom_point(aes(year, 总体性别比/100), color = 'steelblue', size = 4) +\n  geom_label(x = 2022.2, y = 1.04, label = \"总体性别比\", \n             fill = \"steelblue\", color = \"white\", hjust = 0) +\n  scale_color_viridis_c(option = \"C\", breaks = c(0, 25, 50, 75), labels = c(\"0-4岁\", \"25-29岁\", \"50-54岁\", \"75-79岁\"), end = 0.95) +\n  scale_y_continuous(labels = scales::label_percent(), n.breaks = 10) +\n  labs(color = \"年龄段\", y = \"性别比\", x = \"年份\", title = \"2014-2022 男女性别比\") +\n  xlim(2014, 2023.5)\n```\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-33-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n在年轻群体中性别比往往较高，但情况在近年有所改善。\n\n考虑到女性通常与比自己年长的男性结婚，构造错位性别比：比如5-9岁的男性人数与0-4岁的女性人数之比\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_male <- dt_list$dt_male %>% \n  mutate(人口数 = lead(人口数),\n         .by = year) %>% \n  rename(男性人口数 = 人口数)\ndt_female <- dt_list$dt_female %>%\n  # mutate(人口数 = lead(人口数),\n  #        .by = year) %>%\n  rename(女性人口数 = 人口数)\ndt_gender <- dt_male %>% \n  left_join(dt_female, join_by(year, 年龄段))\n\n\ndt_gender %>% \n  rename(女性年龄段 = 年龄段) %>% \n  mutate(总体性别比 = sum(男性人口数, na.rm = TRUE) / sum(女性人口数, na.rm = TRUE), .by = year) %>% \n  mutate(性别比 = 男性人口数 / 女性人口数,\n         age_num = as.integer(str_extract(女性年龄段, \"[^-|岁]+\"))) %>% \n  ggplot(aes(year, 性别比 , color = age_num, group = age_num)) +\n  geom_line(linewidth = 2, alpha = 0.4) +\n  geom_point(size = 4, alpha = 0.4) +\n  geom_line(aes(year, 总体性别比), color = 'steelblue',\n            linewidth = 2) +\n  geom_point(aes(year, 总体性别比), color = 'steelblue', size = 4) +\n  geom_label(x = 2022.2, y = 1.04, label = \"总体性别比\", \n             fill = \"steelblue\", color = \"white\", hjust = 0) +\n  scale_color_viridis_c(option = \"C\", breaks = c(0, 25, 50, 75), labels = c(\"0-4岁\", \"25-29岁\", \"50-54岁\", \"75-79岁\"), end = 0.9) +\n  scale_y_continuous(labels = scales::label_percent(), n.breaks = 10) +\n  labs(color = \"女性年龄段\", y = \"性别比\", x = \"年份\", title = \"2014-2022 男女性别比\") +\n  xlim(2014, 2024)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 8 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 8 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n:::\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-34-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n可以看出，错位性别比相较于性别比更加失衡\n\n## 受教育程度\n\n该数据也是抽样数数据，每年的样本量不同，应该转化为比例数据\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_education %>% \n  mutate(总人口数 = sum(人口数), .by = year) %>% \n  mutate(所占比例 = 人口数 / 总人口数,\n         教育程度 = factor(教育程度, levels = c(\"大专及以上\", \"高中\", \"初中\", \"小学\", \"未上过学\"))) %>% \n  ggplot(aes(year, 所占比例, color = 教育程度, \n             shape = 性别, alpha = 教育程度)) +\n  geom_line(linewidth = 1.8) +\n  geom_point(size = 3.5) +\n  facet_wrap(vars(性别), nrow = 2) +\n  scale_alpha_manual(values = c(1, rep(0.4, 4))) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  scale_color_viridis_d(option = \"C\", end = 0.8) +\n  labs(x = \"年份\", title = \"2004-2023 受教育情况\") +\n  guides(shape = \"none\")\n```\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-35-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n\n中国人的受教育水平在不断提高\n\n## 婚姻状况\n\n该数据集也是抽样数据\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndt_list$dt_marriage %>% \n  mutate(总人口数 = sum(人口数), .by = year) %>% \n  mutate(所占比例 = 人口数 / 总人口数,\n         婚姻状况 = factor(婚姻状况, c(\"未婚\", \"有配偶\", \"离婚\", \"丧偶\"))) %>% \n  ggplot(aes(year, 所占比例, color = 婚姻状况, \n             shape = 性别, alpha = 婚姻状况)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  facet_wrap(vars(性别), nrow = 1) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  scale_color_viridis_d(option = \"C\", end = 0.5) +\n  scale_alpha_manual(values = c(1, rep(0.4, 3))) +\n  labs(x = \"年份\", title = \"2004-2023 婚姻状况\") +\n  guides(shape = \"none\") +\n  theme(legend.position = \"bottom\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 8 rows containing missing values or values outside the scale range\n(`geom_line()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 24 rows containing missing values or values outside the scale range\n(`geom_point()`).\n```\n:::\n\n::: {.cell-output-display}\n![](十年来人口数据分析_files/figure-html/unnamed-chunk-36-1.png){fig-align='center' width=80%}\n:::\n:::\n\n\n男性未婚人口所占的比例在不断上升",
    "supporting": [
      "十年来人口数据分析_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}