[
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "About",
    "section": "",
    "text": "This blog is under building."
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "My Blog",
    "section": "",
    "text": "从pdf读取表格\n\n\n\n\n\n\n\nR\n\n\n\n\n\n\n\n\n\n\n\nApr 10, 2024\n\n\nBowen Qin\n\n\n\n\n\n\n  \n\n\n\n\n实现简单线性回归\n\n\n\n\n\n\n\nR\n\n\neconometrics\n\n\n\n\n\n\n\n\n\n\n\nMar 25, 2024\n\n\nBowen Qin\n\n\n\n\n\n\n  \n\n\n\n\n四人追逐游戏\n\n\n\n\n\n\n\nR\n\n\ncoding\n\n\n\n\n\n\n\n\n\n\n\nMar 10, 2024\n\n\nBowen Qin\n\n\n\n\n\n\n  \n\n\n\n\n构造感知机模型\n\n\n\n\n\n\n\nR\n\n\nML\n\n\n\n\n\n\n\n\n\n\n\nMar 5, 2024\n\n\nBowen Qin\n\n\n\n\n\n\n  \n\n\n\n\n人口数据\n\n\n\n\n\n\n\nR\n\n\ndata analysis\n\n\n\n\n\n\n\n\n\n\n\nFeb 29, 2024\n\n\nBowen Qin\n\n\n\n\n\n\nNo matching items"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html",
    "href": "posts/01-first/十年来人口数据分析.html",
    "title": "人口数据",
    "section": "",
    "text": "文章之前发布在和鲸社区。\nlibrary(tidyverse)\nlibrary(ggrepel)"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html#读入数据",
    "href": "posts/01-first/十年来人口数据分析.html#读入数据",
    "title": "人口数据",
    "section": "1.1 读入数据",
    "text": "1.1 读入数据\n\ndt_rate &lt;- read_csv(\"data/出生率死亡率自然增长率.csv\",\n                    locale = locale(encoding = \"GBK\"))\n\nRows: 3 Columns: 10\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (1): 指标\ndbl (9): 2022年, 2021年, 2020年, 2019年, 2018年, 2017年, 2016年, 2015年, 2014年\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n\ndt_rate &lt;- dt_rate %&gt;% \n  pivot_longer(\n    cols = - 指标,\n    names_to = \"year\"\n  ) %&gt;% \n  pivot_wider(\n    names_from = 指标\n  ) %&gt;% \n  mutate(year = parse_number(year))\ndt_rate\n\n# A tibble: 9 × 4\n   year `人口出生率(‰)` `人口死亡率(‰)` `人口自然增长率(‰)`\n  &lt;dbl&gt;           &lt;dbl&gt;           &lt;dbl&gt;               &lt;dbl&gt;\n1  2022            6.77            7.37               -0.6 \n2  2021            7.52            7.18                0.34\n3  2020            8.52            7.07                1.45\n4  2019           10.4             7.09                3.32\n5  2018           10.9             7.08                3.78\n6  2017           12.6             7.06                5.58\n7  2016           13.6             7.04                6.53\n8  2015           12.0             7.07                4.93\n9  2014           13.8             7.12                6.71\n\n\n其他数据集和该数据集情况类似，可以写个函数批量读入和整理。\n\nread_pivot &lt;- function(file) {\n  read_csv(file, locale = locale(encoding = \"GBK\")) %&gt;% \n    pivot_longer(\n    cols = - 指标,\n    names_to = \"year\"\n  ) %&gt;% \n  pivot_wider(\n    names_from = 指标\n  ) %&gt;% \n  mutate(year = parse_number(year))\n}\n\n\nfiles &lt;- fs::dir_ls(\"data\")\nfile_names &lt;- str_c(\"dt_\", c(\"age_dist\", \"rate\", \"education\", \"female\", \"marriage\", \"age\", \"gender\", \"population\", \"male\"))\nbind_cols(files, file_names)\n\nNew names:\n• `` -&gt; `...1`\n• `` -&gt; `...2`\n\n\n# A tibble: 9 × 2\n  ...1                            ...2         \n  &lt;fs::path&gt;                      &lt;chr&gt;        \n1 data/人口年龄分布.csv           dt_age_dist  \n2 data/出生率死亡率自然增长率.csv dt_rate      \n3 data/受教育程度.csv             dt_education \n4 data/女性年龄分布.csv           dt_female    \n5 data/婚姻状况.csv               dt_marriage  \n6 data/年龄结构.csv               dt_age       \n7 data/性别比.csv                 dt_gender    \n8 data/总人口.csv                 dt_population\n9 data/男性年龄分布.csv           dt_male      \n\n\n\ndt_list &lt;- map(files, read_pivot)\ndt_list &lt;- set_names(dt_list, file_names)\ndt_list[1]\n\n$dt_age_dist\n# A tibble: 10 × 22\n    year 人口数(人口抽样调查)(人…¹ 0-4岁人口数(人口抽样…² 5-9岁人口数(人口抽样…³\n   &lt;dbl&gt;                     &lt;dbl&gt;                  &lt;dbl&gt;                  &lt;dbl&gt;\n 1  2023                        NA                     NA                     NA\n 2  2022                   1443996                  62248                  90793\n 3  2021                   1494054                  72978                  96094\n 4  2020                        NA                     NA                     NA\n 5  2019                   1091876                  62722                  60701\n 6  2018                   1144648                  67393                  63322\n 7  2017                   1145246                  68313                  63314\n 8  2016                   1158019                  68447                  63831\n 9  2015                  21312241                1243566                1174724\n10  2014                   1124402                  63990                  63132\n# ℹ abbreviated names: ¹​`人口数(人口抽样调查)(人)`,\n#   ²​`0-4岁人口数(人口抽样调查)(人)`, ³​`5-9岁人口数(人口抽样调查)(人)`\n# ℹ 18 more variables: `10-14岁人口数(人口抽样调查)(人)` &lt;dbl&gt;,\n#   `15-19岁人口数(人口抽样调查)(人)` &lt;dbl&gt;,\n#   `20-24岁人口数(人口抽样调查)(人)` &lt;dbl&gt;,\n#   `25-29岁人口数(人口抽样调查)(人)` &lt;dbl&gt;,\n#   `30-34岁人口数(人口抽样调查)(人)` &lt;dbl&gt;, …"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html#数据清洗",
    "href": "posts/01-first/十年来人口数据分析.html#数据清洗",
    "title": "人口数据",
    "section": "1.2 数据清洗",
    "text": "1.2 数据清洗\n读入的数据大都不符合整洁数据（一行是一个观测，一列是一个变量）的标准，为了方便作图和分析，需要对数据做一些清洗。\n\n# 人口年龄分布\ndt_list$dt_age_dist &lt;- dt_list$dt_age_dist %&gt;% \n  pivot_longer(\n    cols = - c(year, `人口数(人口抽样调查)(人)`),\n    names_to = \"年龄段\",\n    values_to = \"人口数\"\n  ) %&gt;% \n  mutate(`年龄段` = str_remove(`年龄段`, \"人口数.+\")) %&gt;% \n  rename(`总人口数` = `人口数(人口抽样调查)(人)`)\n\ndt_list$dt_age_dist\n\n# A tibble: 200 × 4\n    year 总人口数 年龄段  人口数\n   &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;\n 1  2023       NA 0-4岁       NA\n 2  2023       NA 5-9岁       NA\n 3  2023       NA 10-14岁     NA\n 4  2023       NA 15-19岁     NA\n 5  2023       NA 20-24岁     NA\n 6  2023       NA 25-29岁     NA\n 7  2023       NA 30-34岁     NA\n 8  2023       NA 35-39岁     NA\n 9  2023       NA 40-44岁     NA\n10  2023       NA 45-49岁     NA\n# ℹ 190 more rows\n\n\n\n# 出生率死亡率自然增长率\ndt_list$dt_rate &lt;- dt_list$dt_rate %&gt;% \n  pivot_longer(\n    cols = -year,\n    names_to = \"比率名称\",\n    names_pattern = \"人口([^\\\\(]+)\",\n    values_to = \"比值\"\n  )\ndt_list$dt_rate\n\n# A tibble: 27 × 3\n    year 比率名称    比值\n   &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt;\n 1  2022 出生率      6.77\n 2  2022 死亡率      7.37\n 3  2022 自然增长率 -0.6 \n 4  2021 出生率      7.52\n 5  2021 死亡率      7.18\n 6  2021 自然增长率  0.34\n 7  2020 出生率      8.52\n 8  2020 死亡率      7.07\n 9  2020 自然增长率  1.45\n10  2019 出生率     10.4 \n# ℹ 17 more rows\n\n\n\n# 受教育程度\ndt_list$dt_education &lt;- dt_list$dt_education %&gt;% \n  select(-matches(\"[^性]人口数|6岁及6岁以上.性\")) %&gt;% \n  pivot_longer(\n    cols = -year,\n    values_to = \"人口数\",\n    names_to = c(\"教育程度\", \"性别\"),\n    names_pattern = \"6岁及6岁以上([^男|女]+)(男性|女性)人口数\\\\(人口抽样调查\\\\)\\\\(人\\\\)\"\n  )\n\n\ndt_list$dt_education\n\n# A tibble: 170 × 4\n    year 教育程度   性别  人口数\n   &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;dbl&gt;\n 1  2022 未上过学   男性   14948\n 2  2022 未上过学   女性   36444\n 3  2022 小学       男性  167013\n 4  2022 小学       女性  188341\n 5  2022 初中       男性  252064\n 6  2022 初中       女性  215929\n 7  2022 高中       男性  123426\n 8  2022 高中       女性   99455\n 9  2022 大专及以上 男性  137692\n10  2022 大专及以上 女性  127723\n# ℹ 160 more rows\n\n\n\n# 女性年龄分布\ndt_list$dt_female &lt;- dt_list$dt_female %&gt;% \n  select(-`女性人口数(人口抽样调查)(人)`) %&gt;% \n  pivot_longer(\n    cols = -year,\n    names_to = c(\"年龄段\", \"性别\"),\n    names_pattern = \"([^女]+)(女性)\",\n    values_to = \"人口数\"\n  )\n  \ndt_list$dt_female\n\n# A tibble: 160 × 4\n    year 年龄段  性别  人口数\n   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;dbl&gt;\n 1  2022 0-4岁   女性   29658\n 2  2022 5-9岁   女性   42783\n 3  2022 10-14岁 女性   42781\n 4  2022 15-19岁 女性   36873\n 5  2022 20-24岁 女性   34483\n 6  2022 25-29岁 女性   40234\n 7  2022 30-34岁 女性   56267\n 8  2022 35-39岁 女性   53435\n 9  2022 40-44岁 女性   47957\n10  2022 45-49岁 女性   51025\n# ℹ 150 more rows\n\n\n\n# 男性年龄分布\ndt_list$dt_male &lt;- dt_list$dt_male %&gt;% \n  select(-`男性人口数(人口抽样调查)(人)`) %&gt;% \n  pivot_longer(\n    cols = -year,\n    names_to = c(\"年龄段\", \"性别\"),\n    names_pattern = \"([^男]+)(男性)\",\n    values_to = \"人口数\"\n  )\ndt_list$dt_male\n\n# A tibble: 160 × 4\n    year 年龄段  性别  人口数\n   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;dbl&gt;\n 1  2022 0-4岁   男性   32589\n 2  2022 5-9岁   男性   48010\n 3  2022 10-14岁 男性   49065\n 4  2022 15-19岁 男性   42687\n 5  2022 20-24岁 男性   39146\n 6  2022 25-29岁 男性   44806\n 7  2022 30-34岁 男性   60488\n 8  2022 35-39岁 男性   56397\n 9  2022 40-44岁 男性   50422\n10  2022 45-49岁 男性   52930\n# ℹ 150 more rows\n\n\n\n# 性别比\ndt_list$dt_gender &lt;- dt_list$dt_gender %&gt;% \n  pivot_longer(\n    cols = -c(year, `性别比(女=100)(人口抽样调查)`),\n    names_to = \"年龄段\",\n    names_pattern = \"([^性]+)\",\n    values_to = \"性别比\"\n  ) %&gt;% \n  rename(总体性别比 = `性别比(女=100)(人口抽样调查)`)\ndt_list$dt_gender\n\n# A tibble: 160 × 4\n    year 总体性别比 年龄段  性别比\n   &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;\n 1  2022       104. 0-4岁     110.\n 2  2022       104. 5-9岁     112.\n 3  2022       104. 10-14岁   115.\n 4  2022       104. 15-19岁   116.\n 5  2022       104. 20-24岁   114.\n 6  2022       104. 25-29岁   111.\n 7  2022       104. 30-34岁   108.\n 8  2022       104. 35-39岁   106.\n 9  2022       104. 40-44岁   105.\n10  2022       104. 45-49岁   104.\n# ℹ 150 more rows\n\n\n\n# 总人口\ndt_list$dt_population &lt;- dt_list$dt_population %&gt;% \n  pivot_longer(\n    cols = - c(year, `年末总人口(万人)`),\n    names_to = \"类别\",\n    names_pattern = \"([^人]+)\",\n    values_to = \"人口数_万人\"\n  ) %&gt;% \n  rename(总人口_万人 = `年末总人口(万人)`)\ndt_list$dt_population\n\n# A tibble: 36 × 4\n    year 总人口_万人 类别  人口数_万人\n   &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;\n 1  2022      141175 男性        72206\n 2  2022      141175 女性        68969\n 3  2022      141175 城镇        92071\n 4  2022      141175 乡村        49104\n 5  2021      141260 男性        72311\n 6  2021      141260 女性        68949\n 7  2021      141260 城镇        91425\n 8  2021      141260 乡村        49835\n 9  2020      141212 男性        72357\n10  2020      141212 女性        68855\n# ℹ 26 more rows\n\n\n\n# 年龄结构\ndt_list$dt_age &lt;- dt_list$dt_age %&gt;% \n  pivot_longer(\n    cols = - c(year, `年末总人口(万人)`, contains(\"抚养比\")),\n    names_to = \"年龄段\",\n    names_pattern = \"([^人]+)\",\n    values_to = \"人口_万人\"\n  ) %&gt;% \n  mutate(抚养比 = case_when(\n    年龄段 == \"0-14岁\" ~ `少儿抚养比(%)`,\n    年龄段 == \"65岁及以上\" ~ `老年抚养比(%)`,\n    TRUE ~ NA\n  )) %&gt;% \n  select(-`少儿抚养比(%)`, -`老年抚养比(%)`)\n\ndt_list$dt_age\n\n# A tibble: 27 × 6\n    year `年末总人口(万人)` `总抚养比(%)` 年龄段     人口_万人 抚养比\n   &lt;dbl&gt;              &lt;dbl&gt;         &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;  &lt;dbl&gt;\n 1  2022             141175          46.6 0-14岁         23908   24.8\n 2  2022             141175          46.6 15-64岁        96289   NA  \n 3  2022             141175          46.6 65岁及以上     20978   21.8\n 4  2021             141260          46.3 0-14岁         24678   25.6\n 5  2021             141260          46.3 15-64岁        96526   NA  \n 6  2021             141260          46.3 65岁及以上     20056   20.8\n 7  2020             141212          45.9 0-14岁         25277   26.2\n 8  2020             141212          45.9 15-64岁        96871   NA  \n 9  2020             141212          45.9 65岁及以上     19064   19.7\n10  2019             141008          41.5 0-14岁         23689   23.8\n# ℹ 17 more rows\n\n\n婚姻状况的数据比较复杂，存在许多缺失值。\n\ndt_list$dt_marriage %&gt;% \n  mutate(across(-year, is.na)) %&gt;% \n  pivot_longer(cols = -year) %&gt;% \n  mutate(name = fct(name, levels = colnames(dt_list$dt_marriage))) %&gt;% \n  ggplot(aes(x = year, y = fct_rev(name), fill = value)) +\n  geom_tile() +\n  scale_fill_brewer(palette = \"Paired\", direction = -1,\n                    limits = c(FALSE, TRUE), labels = c(\"存在\", \"缺失\")) +\n  theme(legend.position = \"top\") +\n  coord_equal(xlim = c(2003.5, 2023.5), expand = FALSE) +\n  labs(x = \"年份\", y = \"类别\", fill = \"数据是否存在\")\n\n\n\n\n\n\n\n\n由上图可知，和配偶相关的数据在2015年以后被整合为有配偶人数、男性有配偶人数和女性有配偶人数。为保持一致，需要把2015年前的数据也整合起来。\n\n# 婚姻状况\ndt_list$dt_marriage &lt;- dt_list$dt_marriage %&gt;% \n  mutate(`15岁及以上男性有配偶人口数(人口抽样调查)(人)` = rowSums(pick(matches(\"男性.*有配偶\")), na.rm = TRUE),\n         `15岁及以上女性有配偶人口数(人口抽样调查)(人)` = rowSums(pick(matches(\"女性.*有配偶\")), na.rm = TRUE),\n         `15岁及以上有配偶人口数(人口抽样调查)(人)` = `15岁及以上男性有配偶人口数(人口抽样调查)(人)` + `15岁及以上女性有配偶人口数(人口抽样调查)(人)`) %&gt;% \n  select(-matches(\"婚有配偶\")) %&gt;% \n  mutate(across(everything(), \\(x) if_else(x == 0, NA, x)))\n\n\ndt_list$dt_marriage %&gt;% \n  mutate(across(-year, is.na)) %&gt;% \n  pivot_longer(cols = -year) %&gt;% \n  mutate(name = fct(name, levels = colnames(dt_list$dt_marriage))) %&gt;% \n  ggplot(aes(x = year, y = fct_rev(name), fill = value)) +\n  geom_tile() +\n  scale_fill_brewer(palette = \"Paired\", direction = -1,\n                    limits = c(FALSE, TRUE), labels = c(\"存在\", \"缺失\")) +\n  labs(fill = \"数据是否存在\") +\n  theme(legend.position = \"top\") +\n  coord_equal(xlim = c(2003.5, 2023.5), expand = FALSE) +\n  labs(x = \"年份\", y = \"类别\")\n\n\n\n\n\n\n\n\n\ndt_list$dt_marriage &lt;- dt_list$dt_marriage %&gt;% \n  select(year, contains(\"性\"), - `15岁及以上男性人口数(人口抽样调查)(人)`, - `15岁及以上女性人口数(人口抽样调查)(人)`) %&gt;% \n  pivot_longer(\n    cols = - year,\n    names_to = c(\"性别\", \"婚姻状况\"),\n    names_pattern = \"15岁及以上(.性)([^人]+)\",\n    values_to = \"人口数\"\n  )"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html#总人口数据",
    "href": "posts/01-first/十年来人口数据分析.html#总人口数据",
    "title": "人口数据",
    "section": "2.1 总人口数据",
    "text": "2.1 总人口数据\n十年来人口趋势\n\np_pop_gen_1 &lt;- dt_list$dt_population %&gt;% \n  filter(str_detect(类别, \"性\")) %&gt;% \n  ggplot(aes(x = year, y = 人口数_万人, color = 类别)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_comma()) +\n  labs(x = \"年份\", y = \"人口数(万人)\")\n\n\np_pop_gen_2 &lt;- dt_list$dt_population %&gt;% \n  mutate(所占比例 = 人口数_万人 / 总人口_万人) %&gt;% \n  filter(str_detect(类别, \"性\")) %&gt;% \n  ggplot(aes(x = year, y = 所占比例, color = 类别)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_percent(), limits = c(0.425, 0.575)) +\n  labs(x = \"年份\")\n\n\nlibrary(patchwork)\np_pop_gen_1 / p_pop_gen_2 +\n plot_layout(guides = \"collect\") +\n  plot_annotation(title = \"2014 - 2022 男女人口趋势\")&\n  scale_color_viridis_d(option = \"C\", end = 0.5)\n\n\n\n\n\n\n\n\n从2014年到2022年，男女人口数量的上升趋于平缓，而男女的比例大致不变。\n\np_pop_city_1 &lt;- dt_list$dt_population %&gt;% \n  filter(!str_detect(类别, \"性\")) %&gt;% \n  ggplot(aes(x = year, y = 人口数_万人, color = 类别)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_comma()) +\n  labs(x = \"年份\", y = \"人口数(万人)\")\n\n\np_pop_city_2 &lt;- dt_list$dt_population %&gt;% \n  mutate(所占比例 = 人口数_万人 / 总人口_万人) %&gt;% \n  filter(!str_detect(类别, \"性\")) %&gt;% \n  ggplot(aes(x = year, y = 所占比例, color = 类别)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_percent(), limits = c(0.25, 0.75)) +\n  labs(x = \"年份\")\n\n\np_pop_city_1 / p_pop_city_2 +\n  plot_layout(guides = \"collect\") +\n  plot_annotation(title = \"2014 - 2022 城乡人口变化\") &\n  scale_color_viridis_d(option = \"C\", end = 0.5)\n\n\n\n\n\n\n\n\n从2014年到2022年，农村人口不断流向城市。"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html#出生率死亡率自然增长率",
    "href": "posts/01-first/十年来人口数据分析.html#出生率死亡率自然增长率",
    "title": "人口数据",
    "section": "2.2 出生率死亡率自然增长率",
    "text": "2.2 出生率死亡率自然增长率\n\ndt_list$dt_rate %&gt;% \n  mutate(alpha = if_else(比率名称 == \"死亡率\", 0.25, 1)) %&gt;% \n  ggplot(aes(x = year, y = 比值/100, color = 比率名称, alpha = alpha)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  scale_alpha(range = c(0.25, 1)) +\n  scale_color_viridis_d(option = \"C\", end = 0.5) +\n  labs(y = \"比值\", x = \"年份\", title = \"2014 - 2022 \\n人口出生率、死亡率、自然增长率\") +\n  guides(alpha = \"none\") \n\n\n\n\n\n\n\n\n从上图可以看出，十年来死亡率基本持平而，自然增长率的下降主要是由于出生率的下降而导致的。"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html#年龄结构",
    "href": "posts/01-first/十年来人口数据分析.html#年龄结构",
    "title": "人口数据",
    "section": "2.3 年龄结构",
    "text": "2.3 年龄结构\n\np_age_1 &lt;- dt_list$dt_age %&gt;% \n  ggplot(aes(year, 人口_万人, color = 年龄段)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  scale_y_continuous(labels = scales::label_comma()) +\n  labs(y = \"人口（万人）\", x = \"年份\")\n\n\np_age_2 &lt;- dt_list$dt_age %&gt;% \n  # filter(!is.na(抚养比)) %&gt;% \n  ggplot(aes(year, 抚养比/100, color = 年龄段)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  #scale_color_discrete(breaks = c(\"0-14岁\", \"65岁及以上\")) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  labs(y = \"抚养比\", x = \"年份\")\n\np_age_1 / p_age_2 +\n  plot_annotation(title = \"2014-2022 年龄结构\") +\n  plot_layout(guides = \"collect\") &\n  scale_color_viridis_d(option = \"C\", end = 0.5)\n\nWarning: Removed 9 rows containing missing values or values outside the scale range\n(`geom_line()`).\n\n\nWarning: Removed 9 rows containing missing values or values outside the scale range\n(`geom_point()`).\n\n\n\n\n\n\n\n\n\n人口的抚养比不断攀升，0-14岁的抚养比在2020年达到顶点后略有下降，而65岁及以上人群的抚养比在不断上升，反映出当前社会的老龄化现象正越来越严重。"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html#人口年龄分布",
    "href": "posts/01-first/十年来人口数据分析.html#人口年龄分布",
    "title": "人口数据",
    "section": "2.4 人口年龄分布",
    "text": "2.4 人口年龄分布\n\ndt_list$dt_age_dist %&gt;% \n  ggplot(aes(x = year, y = 总人口数)) +\n  geom_line(linewidth = 2, col = \"#A52A2A\") +\n  geom_point(size = 4, col = \"#A52A2A\") +\n  scale_y_continuous(labels = scales::label_comma()) +\n  labs(x = \"年份\", y = \"样本量\", title = \"2014-2022 样本量\")\n\nWarning: Removed 20 rows containing missing values or values outside the scale range\n(`geom_line()`).\n\n\nWarning: Removed 40 rows containing missing values or values outside the scale range\n(`geom_point()`).\n\n\n\n\n\n\n\n\n\n该数据是抽样数据，且由上图可以看出，2015年所抽查的样本数量远高于其他年份，因此采用比例数据代替原有数据。\n\ndt_list$dt_age_dist %&gt;% \n  mutate(占总人口比例 = 人口数 / 总人口数) %&gt;% \n  ggplot(aes(x = 年龄段, y = 占总人口比例, fill = 年龄段)) +\n  geom_col() +\n  facet_wrap(vars(year), nrow = 2) +\n  scale_fill_viridis_d(option = \"C\") +\n  scale_x_discrete(breaks = c(\"0-4岁\", \"75-79岁\")) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  guides(fill = \"none\") +\n  theme(axis.text.x = element_text(angle = - 45)) +\n  labs(title = \"2014-2022 人口年龄分布\")\n\nWarning: Removed 40 rows containing missing values or values outside the scale range\n(`geom_col()`).\n\n\n\n\n\n\n\n\n\n人口结构呈现出纺锤型，还未变为倒金字塔型。\n\ndt_list$dt_age_dist %&gt;% \n  mutate(占总人口比例 = 人口数 / 总人口数,\n         age_num = as.integer(str_extract(年龄段, \"[^-|岁]+\"))) %&gt;% \n  arrange(year) %&gt;% \n  mutate(first_ob = first(占总人口比例),\n         last_ob = nth(占总人口比例, -2),\n         .by = 年龄段) %&gt;% \n  mutate(alpha = if_else(last_ob - first_ob &lt; 0, 1, 0.7)) %&gt;% \n  mutate(label = if_else(year == 2022 & alpha == 1, 年龄段, NA),\n         label_y = if_else(!is.na(label), 占总人口比例, NA)) %&gt;% \n  ggplot(aes(x = year, y = 占总人口比例, color = age_num, group = age_num, alpha = alpha)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  geom_label_repel(aes(x = 2022, y = label_y, label = label), nudge_x = 2.2, nudge_y = 0.015, seed = 123) +\n  labs(color = \"年龄段\") +\n  scale_color_viridis_c(option = \"C\", breaks = c(0, 25, 50, 75), labels = c(\"0-4岁\", \"25-29岁\", \"50-54岁\", \"75-79岁\")) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  scale_alpha_continuous(range = c(0.3, 1)) +\n  guides(alpha = \"none\") +\n  labs(x = \"年份\", title = \"2014-2022 年龄分布变化\")\n\nWarning: Removed 20 rows containing missing values or values outside the scale range\n(`geom_line()`).\n\n\nWarning: Removed 40 rows containing missing values or values outside the scale range\n(`geom_point()`).\n\n\nWarning: Removed 193 rows containing missing values or values outside the scale range\n(`geom_label_repel()`).\n\n\n\n\n\n\n\n\n\n可以看出,与十年前相比，年轻人在总人口中所占的比例不断下降，0-4岁人群在总人口中所占的比例下降尤为明显。"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html#男性年龄分布与女性年龄分布",
    "href": "posts/01-first/十年来人口数据分析.html#男性年龄分布与女性年龄分布",
    "title": "人口数据",
    "section": "2.5 男性年龄分布与女性年龄分布",
    "text": "2.5 男性年龄分布与女性年龄分布\n\ndt_gender &lt;- dt_list$dt_male %&gt;% \n  bind_rows(dt_list$dt_female) \n\ndt_gender &lt;- dt_list$dt_age_dist %&gt;% \n  rename(该年龄段总人数 = 人口数) %&gt;%\n  left_join(dt_gender, join_by(year, 年龄段)) %&gt;% \n  mutate(该性别总人数 = sum(人口数), .by = c(year, 性别)) %&gt;% \n  relocate(year, 年龄段, 性别, 人口数, 该性别总人数, 该年龄段总人数)\n\ndt_gender\n\n# A tibble: 360 × 7\n    year 年龄段  性别  人口数 该性别总人数 该年龄段总人数 总人口数\n   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;  &lt;dbl&gt;        &lt;dbl&gt;          &lt;dbl&gt;    &lt;dbl&gt;\n 1  2023 0-4岁   &lt;NA&gt;      NA           NA             NA       NA\n 2  2023 5-9岁   &lt;NA&gt;      NA           NA             NA       NA\n 3  2023 10-14岁 &lt;NA&gt;      NA           NA             NA       NA\n 4  2023 15-19岁 &lt;NA&gt;      NA           NA             NA       NA\n 5  2023 20-24岁 &lt;NA&gt;      NA           NA             NA       NA\n 6  2023 25-29岁 &lt;NA&gt;      NA           NA             NA       NA\n 7  2023 30-34岁 &lt;NA&gt;      NA           NA             NA       NA\n 8  2023 35-39岁 &lt;NA&gt;      NA           NA             NA       NA\n 9  2023 40-44岁 &lt;NA&gt;      NA           NA             NA       NA\n10  2023 45-49岁 &lt;NA&gt;      NA           NA             NA       NA\n# ℹ 350 more rows\n\n\n\ndt_gender %&gt;% \n  filter(!is.na(性别)) %&gt;% \n  mutate(占该性别总人口数的比例 = 人口数 / 该性别总人数) %&gt;% \n  ggplot(aes(x = 年龄段, y = 占该性别总人口数的比例, fill = 年龄段)) +\n  geom_col() +\n  facet_grid(性别 ~ year) +\n  scale_fill_viridis_d(option = \"C\") +\n  scale_x_discrete(breaks = c(\"0-4岁\", \"75-79岁\")) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  guides(fill = \"none\") +\n  theme(axis.text.x = element_text(angle = -45)) +\n  labs(title = \"2014-2022 男女年龄分布\")\n\n\n\n\n\n\n\n\n\ndt_gender %&gt;% \n  filter(!is.na(性别)) %&gt;% \n  mutate(占该性别总人口数的比例 = 人口数 / 该性别总人数,\n         age_num = as.integer(str_extract(年龄段, \"[^-|岁]+\"))) %&gt;% \n  arrange(year) %&gt;% \n  mutate(first_ob = first(占该性别总人口数的比例),\n         last_ob = nth(占该性别总人口数的比例, -2),\n         .by = 年龄段) %&gt;% \n  mutate(alpha = if_else(last_ob - first_ob &lt; 0, 1, 0.7)) %&gt;% \n  mutate(label = if_else(year == 2022 & alpha == 1, 年龄段, NA),\n         label_y = if_else(!is.na(label), 占该性别总人口数的比例, NA)) %&gt;% \n  ggplot(aes(x = year, y = 占该性别总人口数的比例, color = age_num, group = age_num, alpha = alpha)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  geom_label_repel(aes(x = 2022, y = label_y, label = label), nudge_x = 2.2, nudge_y = 0.015, seed = 123) +\n  labs(color = \"年龄段\") +\n  facet_wrap(vars(性别), nrow = 1) +\n  scale_color_viridis_c(option = \"C\", breaks = c(0, 25, 50, 75), labels = c(\"0-4岁\", \"25-29岁\", \"50-54岁\", \"75-79岁\")) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  scale_alpha_continuous(range = c(0.3, 1)) +\n  guides(alpha = \"none\")  +\n  theme(legend.position = \"bottom\", \n        legend.key.width = unit(35, \"pt\")) +\n  labs(title = \"2014-2022 男女年龄分布变化\", x = \"年份\")\n\nWarning: Removed 306 rows containing missing values or values outside the scale range\n(`geom_label_repel()`).\n\n\n\n\n\n\n\n\n\n男性与女性年龄分布的变化与总人口年龄分布的变化一致。"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html#性别比",
    "href": "posts/01-first/十年来人口数据分析.html#性别比",
    "title": "人口数据",
    "section": "2.6 性别比",
    "text": "2.6 性别比\n\ndt_list$dt_gender\n\n# A tibble: 160 × 4\n    year 总体性别比 年龄段  性别比\n   &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;\n 1  2022       104. 0-4岁     110.\n 2  2022       104. 5-9岁     112.\n 3  2022       104. 10-14岁   115.\n 4  2022       104. 15-19岁   116.\n 5  2022       104. 20-24岁   114.\n 6  2022       104. 25-29岁   111.\n 7  2022       104. 30-34岁   108.\n 8  2022       104. 35-39岁   106.\n 9  2022       104. 40-44岁   105.\n10  2022       104. 45-49岁   104.\n# ℹ 150 more rows\n\n\n\ndt_list$dt_gender %&gt;% \n  mutate(age_num = as.integer(str_extract(年龄段, \"[^-|岁]+\"))) %&gt;% \n  ggplot(aes(year, 性别比/100 , color = age_num, group = age_num)) +\n  geom_line(linewidth = 2, alpha = 0.4) +\n  geom_point(size = 4, alpha = 0.4) +\n  geom_line(aes(year, 总体性别比/100), color = 'steelblue',\n            linewidth = 2) +\n  geom_point(aes(year, 总体性别比/100), color = 'steelblue', size = 4) +\n  geom_label(x = 2022.2, y = 1.04, label = \"总体性别比\", \n             fill = \"steelblue\", color = \"white\", hjust = 0) +\n  scale_color_viridis_c(option = \"C\", breaks = c(0, 25, 50, 75), labels = c(\"0-4岁\", \"25-29岁\", \"50-54岁\", \"75-79岁\"), end = 0.95) +\n  scale_y_continuous(labels = scales::label_percent(), n.breaks = 10) +\n  labs(color = \"年龄段\", y = \"性别比\", x = \"年份\", title = \"2014-2022 男女性别比\") +\n  xlim(2014, 2023.5)\n\n\n\n\n\n\n\n\n上图表明，在年轻群体中性别比往往较高，但情况在近年有所改善。\n考虑到许多情况下，在一对夫妻中，男性往往比女性年长，构造错位性别比：比如5-9岁的男性人数与0-4岁的女性人数之比。\n\ndt_male &lt;- dt_list$dt_male %&gt;% \n  mutate(人口数 = lead(人口数),\n         .by = year) %&gt;% \n  rename(男性人口数 = 人口数)\ndt_female &lt;- dt_list$dt_female %&gt;%\n  # mutate(人口数 = lead(人口数),\n  #        .by = year) %&gt;%\n  rename(女性人口数 = 人口数)\ndt_gender &lt;- dt_male %&gt;% \n  left_join(dt_female, join_by(year, 年龄段))\n\n\ndt_gender %&gt;% \n  rename(女性年龄段 = 年龄段) %&gt;% \n  mutate(总体性别比 = sum(男性人口数, na.rm = TRUE) / sum(女性人口数, na.rm = TRUE), .by = year) %&gt;% \n  mutate(性别比 = 男性人口数 / 女性人口数,\n         age_num = as.integer(str_extract(女性年龄段, \"[^-|岁]+\"))) %&gt;% \n  ggplot(aes(year, 性别比 , color = age_num, group = age_num)) +\n  geom_line(linewidth = 2, alpha = 0.4) +\n  geom_point(size = 4, alpha = 0.4) +\n  geom_line(aes(year, 总体性别比), color = 'steelblue',\n            linewidth = 2) +\n  geom_point(aes(year, 总体性别比), color = 'steelblue', size = 4) +\n  geom_label(x = 2022.2, y = 1.04, label = \"总体性别比\", \n             fill = \"steelblue\", color = \"white\", hjust = 0) +\n  scale_color_viridis_c(option = \"C\", breaks = c(0, 25, 50, 75), labels = c(\"0-4岁\", \"25-29岁\", \"50-54岁\", \"75-79岁\"), end = 0.9) +\n  scale_y_continuous(labels = scales::label_percent(), n.breaks = 10) +\n  labs(color = \"女性年龄段\", y = \"性别比\", x = \"年份\", title = \"2014-2022 男女性别比\") +\n  xlim(2014, 2024)\n\nWarning: Removed 8 rows containing missing values or values outside the scale range\n(`geom_line()`).\n\n\nWarning: Removed 8 rows containing missing values or values outside the scale range\n(`geom_point()`).\n\n\n\n\n\n\n\n\n\n可以看出，错位性别比相较于性别比更加失衡。预计未来的婚姻市场的竞争会更加激烈，但也会出现越来越多的女性与较自己年轻的男性结婚。"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html#受教育程度",
    "href": "posts/01-first/十年来人口数据分析.html#受教育程度",
    "title": "人口数据",
    "section": "2.7 受教育程度",
    "text": "2.7 受教育程度\n该数据也是抽样数数据，每年的样本量不同，应该转化为比例数据\n\ndt_list$dt_education %&gt;% \n  mutate(总人口数 = sum(人口数), .by = year) %&gt;% \n  mutate(所占比例 = 人口数 / 总人口数,\n         教育程度 = factor(教育程度, levels = c(\"大专及以上\", \"高中\", \"初中\", \"小学\", \"未上过学\"))) %&gt;% \n  ggplot(aes(year, 所占比例, color = 教育程度, \n             shape = 性别, alpha = 教育程度)) +\n  geom_line(linewidth = 1.8) +\n  geom_point(size = 3.5) +\n  facet_wrap(vars(性别), nrow = 2) +\n  scale_alpha_manual(values = c(1, rep(0.4, 4))) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  scale_color_viridis_d(option = \"C\", end = 0.8) +\n  labs(x = \"年份\", title = \"2004-2023 受教育情况\") +\n  guides(shape = \"none\")\n\n\n\n\n\n\n\n\n中国人的受教育水平在不断提高，教育程度在大专及以上的人显著上升。"
  },
  {
    "objectID": "posts/01-first/十年来人口数据分析.html#婚姻状况",
    "href": "posts/01-first/十年来人口数据分析.html#婚姻状况",
    "title": "人口数据",
    "section": "2.8 婚姻状况",
    "text": "2.8 婚姻状况\n该数据集也是抽样数据，也需要转化为比例数据。\n\ndt_list$dt_marriage %&gt;% \n  mutate(总人口数 = sum(人口数), .by = year) %&gt;% \n  mutate(所占比例 = 人口数 / 总人口数,\n         婚姻状况 = factor(婚姻状况, c(\"未婚\", \"有配偶\", \"离婚\", \"丧偶\"))) %&gt;% \n  ggplot(aes(year, 所占比例, color = 婚姻状况, \n             shape = 性别, alpha = 婚姻状况)) +\n  geom_line(linewidth = 2) +\n  geom_point(size = 4) +\n  facet_wrap(vars(性别), nrow = 1) +\n  scale_y_continuous(labels = scales::label_percent()) +\n  scale_color_viridis_d(option = \"C\", end = 0.5) +\n  scale_alpha_manual(values = c(1, rep(0.4, 3))) +\n  labs(x = \"年份\", title = \"2004-2023 婚姻状况\") +\n  guides(shape = \"none\") +\n  theme(legend.position = \"bottom\")\n\nWarning: Removed 8 rows containing missing values or values outside the scale range\n(`geom_line()`).\n\n\nWarning: Removed 24 rows containing missing values or values outside the scale range\n(`geom_point()`).\n\n\n\n\n\n\n\n\n\n男性未婚人口所占的比例在上升地十分明显，预计在未来，男性在婚姻市场上面临的竞争会更加激烈。"
  },
  {
    "objectID": "posts/02-PLA/02.PLA.html",
    "href": "posts/02-PLA/02.PLA.html",
    "title": "构造感知机模型",
    "section": "",
    "text": "构造感知机模型"
  },
  {
    "objectID": "posts/02-PLA/02.PLA.html#pla",
    "href": "posts/02-PLA/02.PLA.html#pla",
    "title": "构造感知机模型",
    "section": "1 PLA",
    "text": "1 PLA\n\nlibrary(tidyverse)\nlibrary(plotly)\ntheme_set(theme_minimal())\nknitr::opts_chunk$set(\n  out.width = \"80%\",\n  fig.align = \"center\",\n  dev = \"ragg_png\"\n)\n\n\nset.seed(123)\nn = 2000\ndf &lt;- tibble(\n  id = 1:n,\n  x1 = rnorm(n),\n  x2 = rnorm(n),\n  y = if_else(2*x1 + 3*x2 &gt;= 0, 1, -1)\n) %&gt;% \n  arrange(id)\ndf\n\n# A tibble: 2,000 × 4\n      id      x1     x2     y\n   &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;\n 1     1 -0.560  -0.512    -1\n 2     2 -0.230   0.237     1\n 3     3  1.56   -0.542     1\n 4     4  0.0705  1.22      1\n 5     5  0.129   0.174     1\n 6     6  1.72   -0.615     1\n 7     7  0.461  -1.81     -1\n 8     8 -1.27   -0.644    -1\n 9     9 -0.687   2.05      1\n10    10 -0.446  -0.561    -1\n# ℹ 1,990 more rows\n\n\n\ndf %&gt;% \n  ggplot(aes(x1, x2, color = as_factor(y))) +\n  geom_point(alpha = 0.5) +\n  labs(\n    x = latex2exp::TeX(\"$x_1$\"),\n    y = latex2exp::TeX(\"$x_2$\"),\n    color = \"y\"\n  ) +\n  scale_color_brewer(palette = \"Set2\")\n\n\n\n\n\n\n\n\n\npla_near &lt;- function(df, total_times){\n  errors = 0\n  n = 0\n  w = c(0, 0)\n  ddd = df %&gt;% \n  mutate(score = pmap_dbl(list(x1, x2), .f = \\(x, y) if_else(w %*% c(x, y) &gt;= 0, 1, -1))) %&gt;% \n  filter(score != y)\n  while(nrow(ddd) &gt; 0 & n &lt; total_times) {\n    # i = sample(1:nrow(ddd), size = 1)\n    # x = c(ddd$x1[[i]], ddd$x2[[i]])\n    # y = ddd$y[[i]]\n    x = c(ddd$x1[[1]], ddd$x2[[1]])\n    y = ddd$y[[1]]\n    w = w + y*x\n    n = n + 1\n    errors[[n]] = nrow(ddd)\n    ddd = df %&gt;% \n  mutate(score = pmap_dbl(list(x1, x2), .f = \\(x, y) if_else(w %*% c(x, y) &gt;= 0, 1, -1))) %&gt;% \n  filter(y != score)\n  }\n  return(list(w = w, n = n, errors = errors))\n}\n\npla_random &lt;- function(df, total_times){\n  errors = rep(NA, total_times)\n  n = 0\n  w = c(0, 0)\n  ddd = df %&gt;% \n  mutate(score = pmap_dbl(list(x1, x2), .f = \\(x, y) if_else(w %*% c(x, y) &gt;= 0, 1, -1))) %&gt;% \n  filter(score != y)\n  while(nrow(ddd) &gt; 0 & n &lt; total_times) {\n    i = sample(1:nrow(ddd), size = 1)\n    x = c(ddd$x1[[i]], ddd$x2[[i]])\n    y = ddd$y[[i]]\n    w = w + y*x\n    n = n + 1\n    errors[[n]] = nrow(ddd)\n    ddd = df %&gt;% \n  mutate(score = pmap_dbl(list(x1, x2), .f = \\(x, y) if_else(w %*% c(x, y) &gt;= 0, 1, -1))) %&gt;% \n  filter(y != score)\n  }\n  return(list(w = w, n = n, errors = errors))\n}\n\n\nT_times &lt;- 500\nrrr_near &lt;- pla_near(df, T_times)\nrrr_random &lt;- pla_random(df, T_times)\ndf_result &lt;- tibble(\n  n = 1:T_times,\n  near_errors = rrr_near$errors,\n  random_errors = rrr_random$errors\n)\n\n\ndf_result %&gt;% \n  pivot_longer(\n    cols = -n\n  ) %&gt;% \n  ggplot(aes(n, value, color = name)) +\n  geom_path(alpha = 0.5)\n\nWarning: Removed 202 rows containing missing values or values outside the scale range\n(`geom_path()`).\n\n\n\n\n\n\n\n\n\n\ndf %&gt;% \n  mutate(score_near = pmap_dbl(list(x1, x2), .f = \\(x, y) if_else(rrr_near$w %*% c(x, y) &gt;= 0, 1, -1)),\n         score_random = pmap_dbl(list(x1, x2), .f = \\(x, y) if_else(rrr_random$w %*% c(x, y) &gt;= 0, 1, -1))) %&gt;% \n  filter(score_random != y | score_near != y)\n\n# A tibble: 15 × 6\n      id      x1      x2     y score_near score_random\n   &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;\n 1   325 -0.523   0.336     -1          1           -1\n 2   334  1.52   -1.01       1         -1            1\n 3   394 -0.829   0.546     -1          1           -1\n 4   711  1.06   -0.667      1         -1            1\n 5   741  0.712  -0.468      1         -1            1\n 6   847 -0.644   0.421     -1          1           -1\n 7   854 -1.16    0.754     -1          1           -1\n 8  1094  1.02   -0.640      1         -1            1\n 9  1111 -0.625   0.411     -1          1           -1\n10  1151 -0.0570  0.0372    -1          1           -1\n11  1268  1.43   -0.929      1         -1            1\n12  1304  0.354  -0.228      1         -1            1\n13  1448 -1.99    1.28      -1          1           -1\n14  1449  0.551  -0.358      1         -1            1\n15  1804  1.26   -0.801      1         -1            1\n\n\n\nf_1 = function(x){\nx * rrr_near$w[[1]] / (-rrr_near$w[[2]])\n}\n\nf_2 = function(x){\nx * rrr_random$w[[1]] / (-rrr_random$w[[2]])\n}\n\ndf %&gt;% \n  ggplot(aes(x1, x2)) +\n  geom_point(aes(color = as_factor(y))) +\n  geom_function(fun = f_1, lty = 2, color = \"red\") +\n  geom_function(fun = f_2, lty = 2, color = \"blue\") +\n  labs(color = \"y\")"
  },
  {
    "objectID": "posts/02-PLA/02.PLA.html#modify-pla",
    "href": "posts/02-PLA/02.PLA.html#modify-pla",
    "title": "构造感知机模型",
    "section": "2 modify PLA",
    "text": "2 modify PLA\n\nset.seed(111)\nn = 2000\ndf &lt;- tibble(\n  id = 1:n,\n  x1 = rnorm(n),\n  x2 = rnorm(n),\n  e = rnorm(n),\n  y = if_else(2*x1 + 3*x2 + e &gt;= 0, 1, -1)\n) %&gt;% \n  arrange(id)\ndf\n\n# A tibble: 2,000 × 5\n      id     x1      x2      e     y\n   &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;\n 1     1  0.235  1.13    0.141     1\n 2     2 -0.331  0.858  -0.600     1\n 3     3 -0.312 -0.574  -1.06     -1\n 4     4 -2.30   1.38    1.89      1\n 5     5 -0.171 -0.575  -0.657    -1\n 6     6  0.140 -0.593  -1.15     -1\n 7     7 -1.50  -1.42   -1.10     -1\n 8     8 -1.01   0.0288 -1.44     -1\n 9     9 -0.948 -0.361   0.823    -1\n10    10 -0.494  0.508   0.147     1\n# ℹ 1,990 more rows\n\n\n\ndf %&gt;% \n  ggplot(aes(x1, x2, color = as_factor(y))) +\n  geom_point(alpha = 0.5)\n\n\n\n\n\n\n\n\n\npla_best &lt;- function(df, total_times){\n  n = 0\n  w = c(0,0)\n  ws = list()\n  errors = nrow(df)\n  while (last(errors) &gt; 0 & n &lt; total_times) {\n    n = n + 1\n    ddd = df %&gt;% \n    mutate(score = pmap_dbl(list(x1, x2), \n                            \\(x, y) if_else((w %*% c(x, y)) &gt;= 0, 1, -1))) %&gt;% \n    filter(score != y)\n    i = sample(1:nrow(ddd), size = 1)\n    errors[[n]] = nrow(ddd)\n    x = c(ddd$x1[[i]], ddd$x2[[i]])\n    y = ddd$y[[i]]\n    w = w + y*x\n    ws[[n]] = w\n  }\n  return(list(ws = ws, n = n, errors = errors))\n}\n\npla_modify &lt;- function(df, total_times, w = c(0, 0)){\n  n = 0\n  #ws = list()\n  errors = nrow(df)\n  while (last(errors) &gt; 0 & n &lt; total_times) {\n    n = n + 1\n    # ddd = df %&gt;% \n    #   mutate(score = pmap_dbl(list(x1, x2), \n    #                           \\(x, y) if_else((w %*% c(x, y)) &gt;= 0, 1, -1))) %&gt;% \n    #   filter(score != y)\n    \n    w_list = pmap(df, \n                  \\(x1, x2, y, ...) w + y * c(x1, x2)) %&gt;% \n      sample(size = min(floor(0.1 * nrow(df)), 100))\n    \n    n_errors = map_dbl(w_list, \\(x) sum(pmap_dbl(df, \\(x1, x2, ...) sign(c(x1, x2) %*% x)) != df$y))\n    \n    min_errors = min(n_errors)\n    w_list_min_e = w_list[[which.min(n_errors)]]\n    if (min_errors &lt;= last(errors)) {\n      w = w_list_min_e\n      errors[[n]] = min_errors\n    }else{\n      w = w\n      errors[[n]] = last(errors)\n    }\n    if (n&gt;20) {\n      if (errors[[n-20]] == errors[[n]]){\n        break\n      }\n    }\n  }\n  return(list(w = w, n = n, errors = errors))\n}\n\n\ntotal_times &lt;-  88\nrrr_best &lt;- pla_best(df, total_times)\nrrr_modify &lt;- pla_modify(df, total_times)\n\n\ndf_result &lt;- tibble(\n  n = 1:total_times,\n  errors_modify = c(rrr_modify$errors, rep(NA, total_times - length(rrr_modify$errors))),\n  errors_best = rrr_best$errors\n)\n\ndf_result %&gt;% \n  pivot_longer(-n) %&gt;% \n  ggplot(aes(n, value, color = name)) +\n  geom_line(linewidth = 1, alpha = 0.5) +\n  geom_point(alpha = 0.5) +\n  coord_cartesian(ylim = c(100, 300))\n\nWarning: Removed 59 rows containing missing values or values outside the scale range\n(`geom_line()`).\n\n\nWarning: Removed 59 rows containing missing values or values outside the scale range\n(`geom_point()`).\n\n\n\n\n\n\n\n\n\n\nw &lt;- rrr_best$ws[[which.min(rrr_best$errors)]]\nf_3 &lt;- function(x){\nx * w[[1]] / (-w[[2]])\n}\n\nf_4 &lt;- function(x){\nx * rrr_modify$w[[1]] / (-rrr_modify$w[[2]])\n}\n\ndf %&gt;% \n  mutate(score = pmap_dbl(df, \\(x1, x2, ...) sign(c(x1, x2) %*% rrr_modify$w)),\n         alpha = if_else(score == y, 0.25, 1)) %&gt;% \n  ggplot(aes(x1, x2)) +\n  geom_point(aes(color = as_factor(y), alpha = alpha)) +\n  geom_function(fun = f_3, lty = 2, color = \"purple\") +\n  geom_function(fun = f_4, lty = 2, color = \"skyblue\") +\n  labs(color = \"y\") +\n  coord_equal()\n\n\n\n\n\n\n\n\n\nw0 &lt;- c(2, 3)\nw0_erors &lt;- df %&gt;% \n  mutate(score = pmap_dbl(list(x1, x2), \n                            \\(x, y) if_else((w0 %*% c(x, y)) &gt;= 0, 1, -1))) %&gt;% \n  filter(score != y) %&gt;% \n  nrow()\n\npla_best_errors &lt;- min(rrr_best$errors)\npla_modify_errors &lt;- last(rrr_modify$errors)\ntibble(\n  w0_erors,\n  pla_best_errors,\n  pla_modify_errors\n)\n\n# A tibble: 1 × 3\n  w0_erors pla_best_errors pla_modify_errors\n     &lt;int&gt;           &lt;int&gt;             &lt;dbl&gt;\n1      134             129               127"
  },
  {
    "objectID": "posts/02-PLA/02.PLA.html#linear-regression-and-modify-pla",
    "href": "posts/02-PLA/02.PLA.html#linear-regression-and-modify-pla",
    "title": "构造感知机模型",
    "section": "3 linear regression and modify PLA",
    "text": "3 linear regression and modify PLA\n\npla_modify &lt;- function(df, total_times, w = c(0, 0, 0)){\n  n = 0\n  #ws = list()\n  errors = nrow(df)\n  while (last(errors) &gt; 0 & n &lt; total_times) {\n    n = n + 1\n    # ddd = df %&gt;% \n    #   mutate(score = pmap_dbl(list(x1, x2), \n    #                           \\(x, y) if_else((w %*% c(x, y)) &gt;= 0, 1, -1))) %&gt;% \n    #   filter(score != y)\n    \n    w_list = pmap(df, \n                  \\(x1, x2, y, ...) w + y * c(1, x1, x2)) %&gt;% \n      sample(size = min(floor(0.1 * nrow(df)), 100))\n    \n    n_errors = map_dbl(w_list, \\(x) sum(pmap_dbl(df, \\(x1, x2, ...) sign(c(1, x1, x2) %*% x)) != df$y))\n    \n    min_errors = min(n_errors)\n    w_list_min_e = w_list[[which.min(n_errors)]]\n    if (min_errors &lt;= last(errors)) {\n      w = w_list_min_e\n      errors[[n]] = min_errors\n    }else{\n      w = w\n      errors[[n]] = last(errors)\n    }\n    if (n&gt;20) {\n      if (errors[[n-20]] == errors[[n]]){\n        break\n      }\n    }\n  }\n  return(list(w = w, n = n, errors = errors))\n}\n\n\nreg_pla &lt;- function(df, formula, total_times){\n  fit &lt;- lm(formula, data = df)\n  pla_modify(df, total_times, w = fit$coefficients)\n}\n\n\ntotal_times &lt;-  88\nformula &lt;- formula(y ~ x1 + x2)\nmicrobenchmark::microbenchmark(\n  rrr_modify_2 &lt;- pla_modify(df, total_times),\n  rrr_reg_pla &lt;- reg_pla(df, formula, total_times),\n  times = 1\n)\n\nUnit: seconds\n                                             expr      min       lq     mean\n      rrr_modify_2 &lt;- pla_modify(df, total_times) 15.22693 15.22693 15.22693\n rrr_reg_pla &lt;- reg_pla(df, formula, total_times) 14.08558 14.08558 14.08558\n   median       uq      max neval\n 15.22693 15.22693 15.22693     1\n 14.08558 14.08558 14.08558     1\n\n\n\ndf_result &lt;- tibble(\n  n = 1:total_times,\n  errors_modify = c(rrr_modify_2$errors, rep(NA, total_times - length(rrr_modify_2$errors))),\n  errors_reg = c(rrr_reg_pla$errors, rep(NA, total_times - length(rrr_reg_pla$errors)))\n)\n\ndf_result %&gt;% \n  pivot_longer(-n) %&gt;% \n  ggplot(aes(n, value, color = name)) +\n  geom_line(linewidth = 1, alpha = 0.5) +\n  geom_point(alpha = 0.5) +\n  coord_cartesian(ylim = c(100, 300), xlim = c(0, 50))\n\n\n\n\n\n\n\n\n\nf_modify &lt;- function(x){\nrrr_modify_2$w[[1]] + x * rrr_modify$w[[2]] / (-rrr_modify$w[[3]])\n}\n\nf_reg &lt;- function(x){\nrrr_reg_pla$w[[1]] + x * rrr_reg_pla$w[[2]] / (-rrr_reg_pla$w[[3]])\n}\n\ndf %&gt;% \n  mutate(score = pmap_dbl(df, \\(x1, x2, ...) sign(c(1, x1, x2) %*% rrr_reg_pla$w)),\n         alpha = if_else(score == y, 0.25, 1)) %&gt;% \n  ggplot(aes(x1, x2)) +\n  geom_point(aes(color = as_factor(y), alpha = alpha)) +\n  geom_function(fun = f_reg, lty = 2, color = \"purple\") +\n  geom_function(fun = f_modify, lty = 2, color = \"skyblue\") +\n  labs(color = \"y\") +\n  coord_equal()\n\nWarning: Computation failed in `stat_function()`.\nCaused by error in `rrr_modify$w[[3]]`:\n! subscript out of bounds\n\n\n\n\n\n\n\n\n\n\ntibble(\n  err_modify = last(rrr_modify_2$errors),\n  err_reg_pla = last(rrr_reg_pla$errors)\n)\n\n# A tibble: 1 × 2\n  err_modify err_reg_pla\n       &lt;dbl&gt;       &lt;dbl&gt;\n1        129         130"
  },
  {
    "objectID": "posts/03_四人追逐游戏.html",
    "href": "posts/03_四人追逐游戏.html",
    "title": "四人追逐游戏",
    "section": "",
    "text": "游戏的设定是四个人A，B，C，D站在四个角，A追B，B追C，C追D，D追A。高数里面好像经常有类似的题目，今天用代码来模拟一下。\n\nlibrary(tidyverse)\n\n\ndt_list &lt;- list(\n  tibble(\n    name = c(\"A\", \"B\", \"C\", \"D\"),\n    x = c(1, 1, -1, -1),\n    y = c(1, -1, -1, 1),\n    direction = c(2, 3, 4, 1),\n    n = 0\n  )\n)\n\n生成一个tibble，其中\n\nname列表示四个人的名字。\nx、y是坐标。\ndirection列表示追逐的人的行号，比如A追B，B在第二行，所以A对应的direction是2。\nn表示跑了几步，目前没有开始追，所以是0步。\n\n\n# 设置程序最多跑5000步，防止程序出错而不收敛\nN &lt;- 5000   \n# 设置每一步的步长\nstep_length &lt;- 0.01\n\n# 开始循环\nfor (i in 1:N) {\n  dt = dt_list[[i]]\n  x_diff = max(dt$x) - min(dt$x)\n  y_diff = max(dt$y) - min(dt$y)\n  # 因为x,y是浮点数，最终可能每个点的x,y都十分接近但不相等，因此用near()来判断\n  if (!all(near(c(x_diff, y_diff), 0))) {\n    dt_list[[i + 1]] &lt;- dt %&gt;% \n      # 每个人向所追的方向迈一步\n      mutate(x_d = as_vector(dt[direction, \"x\"] - x),\n             y_d = as_vector(dt[direction, \"y\"] - y),\n             x = x + x_d * step_length,\n             y = y + y_d * step_length,\n             n = i)\n  } else {\n    break\n  }\n}\n\n整理一下结果\n\ndt &lt;- do.call(bind_rows, dt_list)\ndt\n\n# A tibble: 7,572 × 7\n   name       x      y direction     n     x_d     y_d\n   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;\n 1 A      1      1             2     0 NA      NA     \n 2 B      1     -1             3     0 NA      NA     \n 3 C     -1     -1             4     0 NA      NA     \n 4 D     -1      1             1     0 NA      NA     \n 5 A      1      0.98          2     1  0      -2     \n 6 B      0.98  -1             3     1 -2       0     \n 7 C     -1     -0.98          4     1  0       2     \n 8 D     -0.98   1             1     1  2       0     \n 9 A      1.00   0.960         2     2 -0.0200 -1.98  \n10 B      0.960 -1.00          3     2 -1.98    0.0200\n# ℹ 7,562 more rows\n\n\n\ndt %&gt;% \n  slice_max(n)\n\n# A tibble: 4 × 7\n  name         x        y direction     n      x_d      y_d\n  &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;\n1 A      7.44e-9  4.30e-9         2  1892 -3.05e-9 -1.19e-8\n2 B      4.30e-9 -7.44e-9         3  1892 -1.19e-8  3.05e-9\n3 C     -7.44e-9 -4.30e-9         4  1892  3.05e-9  1.19e-8\n4 D     -4.30e-9  7.44e-9         1  1892  1.19e-8 -3.05e-9\n\n\n达到收敛的状态花了1892步，即在步长为0.01时，1892步后四人追到彼此。\n看下四个人的轨迹\n\ndt %&gt;% \n  ggplot(aes(x, y, color = n, pch = name)) +\n  geom_point(alpha = 0.2, size = 3) +\n  geom_text(data = dt_list[[1]],\n            aes(x, y, label = name),\n            nudge_x = 0.1,\n            nudge_y = 0.1) +\n  coord_equal() +\n  scale_color_viridis_c(option = \"C\", end = 0.8, begin = 0.4) +\n  theme_minimal()"
  },
  {
    "objectID": "posts/simple lm.html",
    "href": "posts/simple lm.html",
    "title": "实现简单线性回归",
    "section": "",
    "text": "library(tidyverse)\ntheme_set(hrbrthemes::theme_ipsum_rc())\n\n准备花几期时间，自己写代码，实现常用的计量方法。\n生成模拟数据\n\nset.seed(111)\nx &lt;- 1:4\nnames(x) &lt;- LETTERS[1:4]\ndf &lt;- tibble(\n  x1 = runif(1000, -10, 10),\n  x2 = sample(1:20, 1000, replace = TRUE),\n  x3 = sample(LETTERS[1:4], 1000, replace = TRUE),\n  error = rnorm(1000, sd = 1000),\n  y = 1 + 2 * x1 + 3 * x2 + x[x3]\n)\ndf\n\n# A tibble: 1,000 × 5\n       x1    x2 x3     error     y\n    &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;\n 1  1.86     11 A      285.  38.7 \n 2  4.53      5 B      176.  27.1 \n 3 -2.59     11 A     -610.  29.8 \n 4  0.298     9 A       92.1 29.6 \n 5 -2.45     20 D      611.  60.1 \n 6 -1.63     15 B      170.  44.7 \n 7 -9.79      6 C     -104.   2.43\n 8  0.646    18 A     -253.  57.3 \n 9 -1.36     10 B     -169.  30.3 \n10 -8.13      6 B     -509.   4.75\n# ℹ 990 more rows\n\n\n\n1 步骤拆解\n\nstep 1: 根据formula生成矩阵\n因为formula是R里面一个特殊的class，他的具体机制我没弄清楚，所以这一步用R中的model.matrix.lm()实现\n\nformula &lt;- y ~ x1 + x2 + x3\ndf_model &lt;- model.frame(formula, df)\nX &lt;- model.matrix.lm(df_model)\nhead(X)\n\n  (Intercept)         x1 x2 x3B x3C x3D\n1           1  1.8596257 11   0   0   0\n2           1  4.5296224  5   1   0   0\n3           1 -2.5915599 11   0   0   0\n4           1  0.2984766  9   0   0   0\n5           1 -2.4467357 20   0   0   1\n6           1 -1.6332535 15   1   0   0\n\nY &lt;- model.response(df_model)\nhead(Y)\n\n       1        2        3        4        5        6 \n38.71925 27.05924 29.81688 29.59695 60.10653 44.73349 \n\n\n\n\nstep 2: 得到回归系数\n假设对于总体数据来说：\n\\[\n\\mathbf Y = \\mathbf X \\boldsymbol \\beta + \\boldsymbol \\epsilon\n\\]\n但是我们得到的拟合方程是：\n\\[\n\\hat{\\mathbf Y} = \\mathbf X \\hat{\\boldsymbol \\beta}\n\\]\n且\n\\[\n\\begin{align}\n\\boldsymbol e &= \\mathbf Y - \\hat{\\mathbf Y} \\\\\n&= \\mathbf Y - \\mathbf X \\hat{\\boldsymbol \\beta}\n\\end{align}\n\\]\n要想使\\(\\mathbf Y - \\hat{\\mathbf Y}\\)最小，则\\(\\boldsymbol e\\)与\\(\\mathbf X\\)正交，即\n\\[\n\\begin{align}\n&\\mathbf {X^T (Y - X\\hat{\\beta})} = \\mathbf {0} \\\\\n&\\mathbf {\\hat{\\beta}} = \\mathbf {(X^T X)^{-1}X^{T} Y}\n\\end{align}\n\\]\n\nget_beta &lt;- function(X, Y) {\n  solve(crossprod(X, X)) %*% crossprod(X, Y)\n}\nbeta &lt;- get_beta(X, Y)\nbeta\n\n            [,1]\n(Intercept)    2\nx1             2\nx2             3\nx3B            1\nx3C            2\nx3D            3\n\n\n\n\nstep 3: 求出拟合值和误差\n\\[\n\\begin{align}\n\\mathbf{\\hat{Y}} &= \\mathbf{X\\hat{\\beta}} \\\\\n\\mathbf{e} &= \\mathbf{ Y - \\hat{Y}}\n\\end{align}\n\\]\n\nget_fit &lt;- function(X, beta) {\n  X %*% beta\n}\n\nY_hat &lt;- get_fit(X, beta)\nhead(Y_hat)\n\n      [,1]\n1 38.71925\n2 27.05924\n3 29.81688\n4 29.59695\n5 60.10653\n6 44.73349\n\n\n\nget_residual &lt;- function(Y, Y_hat) {\n  Y - Y_hat\n}\nresidual &lt;- get_residual(Y, Y_hat)\nhead(residual)\n\n           [,1]\n1 -7.105427e-15\n2 -2.842171e-14\n3 -3.552714e-15\n4 -1.421085e-14\n5  2.842171e-14\n6  0.000000e+00\n\n\n\n\nstep 4: 求出系数的标准误\n感觉这一部分的可拓展性比较强，在不同的假设下（同方差、异方差等），系数的标准误不同。这次先假设同方差且无自相关（球形扰动项）。\n求一下自由度\n\nget_freedom &lt;- function(X) {\n  nrow(X) - ncol(X)\n}\nfreedom &lt;- get_freedom(X)\nfreedom\n\n[1] 994\n\n\n\nget_var_sepherical &lt;- function(residual, freedom) {\n  as.numeric(crossprod(residual, residual) / freedom)\n}\nresidual_var &lt;- get_var_sepherical(residual, freedom)\nresidual_var\n\n[1] 5.95194e-28\n\n\n球形扰动项假设下，系数的标准误为\n\\[\n\\mathbf {\\text{SE}(\\hat{\\beta})} = \\mathbf {\\sqrt {\\text{Var}(e) (X^T X)^{-1}_{kk}}}\n\\]\n\nget_beta_se &lt;- function(X, residual_var) {\n  sqrt(residual_var * diag(solve(crossprod(X, X))))\n}\nbeta_se &lt;- get_beta_se(X, residual_var)\nbeta_se\n\n (Intercept)           x1           x2          x3B          x3C          x3D \n2.135352e-15 1.373596e-16 1.354870e-16 2.187586e-15 2.153656e-15 2.223240e-15 \n\n\n\n\nstep 5: 系数的t值和p值\n计算系数的t值\n\\[\nt_k = \\frac{\\hat{\\beta_k} - \\beta_k}{ \\text{SE}(\\hat{ \\beta_k}) }\n\\]\n\nget_beta_t &lt;- function(beta, beta_se, assump = 0) {\n  (beta - assump) / beta_se\n}\nbeta_t &lt;- get_beta_t(beta, beta_se)\nbeta_t\n\n                    [,1]\n(Intercept) 9.366136e+14\nx1          1.456032e+16\nx2          2.214234e+16\nx3B         4.571248e+14\nx3C         9.286532e+14\nx3D         1.349382e+15\n\n\n置信区间\n\\[\n[\\hat{\\beta_k} - t_{\\frac{\\alpha}{2}} \\text{SE}(\\hat{ \\beta_k}),  \n\\hat{\\beta_k} + t_{\\frac{\\alpha}{2}} \\text{SE}(\\hat{ \\beta_k})]\n\\]\n\nget_conf &lt;- function(beta, beta_se, freedom, p = 0.05) {\n  beta_lconf &lt;- beta + qt(p/2, freedom) * beta_se\n  beta_hconf &lt;- beta - qt(p/2, freedom) * beta_se\n  cbind(beta_lconf, beta_hconf)\n}\n\nconf &lt;- get_conf(beta, beta_se, freedom)\nconf\n\n            [,1] [,2]\n(Intercept)    2    2\nx1             2    2\nx2             3    3\nx3B            1    1\nx3C            2    2\nx3D            3    3\n\n\n系数的p-value\n\\[\np = P(|T| &gt; |t_k|)\n\\]\n\nget_pvalue &lt;- function(beta_t, freedom) {\n  2 * pt(abs(beta_t), df = freedom, lower.tail = FALSE)\n}\npvalue &lt;- get_pvalue(beta_t, freedom)\npvalue\n\n            [,1]\n(Intercept)    0\nx1             0\nx2             0\nx3B            0\nx3C            0\nx3D            0\n\n\n\n\nstep 6: 整理结果\n\nresult_df &lt;- as_tibble(beta, rownames = \"term\") %&gt;% \n  rename(estimate = V1) %&gt;% \n  bind_cols(std_error = beta_se,\n            statistics = beta_t[, 1],\n            p_value = pvalue[, 1])\n\nWarning: The `x` argument of `as_tibble.matrix()` must have unique column names if\n`.name_repair` is omitted as of tibble 2.0.0.\nℹ Using compatibility `.name_repair`.\n\n\n\n\n\n2 打包成一个函数\n前面编写的函数有\n\nget_beta &lt;- function(X, Y) {\n  solve(crossprod(X, X)) %*% crossprod(X, Y)\n}\n\nget_fit &lt;- function(X, beta) {\n  X %*% beta\n}\n\nget_residual &lt;- function(Y, Y_hat) {\n  Y - Y_hat\n}\n\nget_freedom &lt;- function(X) {\n  nrow(X) - ncol(X)\n}\n\nget_var_sepherical &lt;- function(residual, freedom) {\n  as.numeric(crossprod(residual, residual) / freedom)\n}\n\nget_beta_se &lt;- function(X, residual) {\n  sqrt(residual * diag(solve(crossprod(X, X))))\n}\n\nget_beta_t &lt;- function(beta, beta_se, assump = 0) {\n  (beta - assump) / beta_se\n}\n\nget_conf &lt;- function(beta, beta_se, freedom, p = 0.05) {\n  beta_lconf &lt;- beta + qt(p/2, freedom) * beta_se\n  beta_hconf &lt;- beta - qt(p/2, freedom) * beta_se\n  cbind(beta_lconf, beta_hconf)\n}\n\nget_pvalue &lt;- function(beta_t, freedom) {\n  2 * pt(abs(beta_t), df = freedom, lower.tail = FALSE)\n}\n\n将这些函数作为积木拼入一个大函数中\n\nmy_lm &lt;- function(formula, df) {\n  df_model &lt;- model.frame(formula, df)\n  X &lt;- model.matrix.lm(df_model)\n  Y &lt;- model.response(df_model)\n  \n  beta &lt;- get_beta(X, Y)\n  \n  Y_hat &lt;- get_fit(X, beta)\n  residual &lt;- get_residual(Y, Y_hat)\n  \n  freedom &lt;- get_freedom(X)\n  residual_var &lt;- get_var_sepherical(residual, freedom)\n  \n  beta_se &lt;- get_beta_se(X, residual_var)\n  \n  beta_t &lt;- get_beta_t(beta, beta_se)\n  #conf &lt;- get_conf(beta, beta_se, freedom)\n  pvalue &lt;- get_pvalue(beta_t, freedom)\n  \n  \n  result_df &lt;- as_tibble(beta,rownames = \"term\") %&gt;% \n    rename(estimate = V1) %&gt;% \n    bind_cols(std_error = beta_se,\n              statistics = beta_t[, 1],\n              p_value = pvalue[, 1])\n  \n  return(result_df)\n}\n\n\nmy_result &lt;- my_lm(y ~ x1 + x2 + x3, df = df)\nmy_result\n\n# A tibble: 6 × 5\n  term        estimate std_error statistics p_value\n  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;\n1 (Intercept)     2.00  2.14e-15    9.37e14       0\n2 x1              2.00  1.37e-16    1.46e16       0\n3 x2              3     1.35e-16    2.21e16       0\n4 x3B             1     2.19e-15    4.57e14       0\n5 x3C             2.00  2.15e-15    9.29e14       0\n6 x3D             3.00  2.22e-15    1.35e15       0\n\n\n\n\n3 和lm()的结果对比\n\nlm_result &lt;- lm(y ~ x1 + x2 + x3, df) %&gt;% \n  broom::tidy()\n\nWarning in summary.lm(x): essentially perfect fit: summary may be unreliable\n\nlm_result\n\n# A tibble: 6 × 5\n  term        estimate std.error statistic p.value\n  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;\n1 (Intercept)     2     9.24e-16   2.16e15       0\n2 x1              2     5.94e-17   3.37e16       0\n3 x2              3     5.86e-17   5.12e16       0\n4 x3B             1.00  9.47e-16   1.06e15       0\n5 x3C             2.00  9.32e-16   2.15e15       0\n6 x3D             3     9.62e-16   3.12e15       0\n\n\n结果看起来不对，但其实是浮点数的数字存储机制造成的，比如\n\nsqrt(2) ^ 2 == 2\n\n[1] FALSE\n\n\n这时应该使用near()来判断两个数是否相等\n\nnear(sqrt(2) ^ 2, 2)\n\n[1] TRUE\n\n\n\nnear(my_result$std_error, lm_result$std.error)\n\n(Intercept)          x1          x2         x3B         x3C         x3D \n       TRUE        TRUE        TRUE        TRUE        TRUE        TRUE \n\n\n\nnear(my_result$statistics, lm_result$statistic)\n\n(Intercept)          x1          x2         x3B         x3C         x3D \n      FALSE       FALSE       FALSE       FALSE       FALSE       FALSE \n\n\n最终得到的t值不同，原因还不清楚。\n\n\n4 使用真实的数据集\n\nmtcars\n\n# A tibble: 32 × 11\n     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb\n   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;\n 1  21       6  160    110  3.9   2.62  16.5     0     1     4     4\n 2  21       6  160    110  3.9   2.88  17.0     0     1     4     4\n 3  22.8     4  108     93  3.85  2.32  18.6     1     1     4     1\n 4  21.4     6  258    110  3.08  3.22  19.4     1     0     3     1\n 5  18.7     8  360    175  3.15  3.44  17.0     0     0     3     2\n 6  18.1     6  225    105  2.76  3.46  20.2     1     0     3     1\n 7  14.3     8  360    245  3.21  3.57  15.8     0     0     3     4\n 8  24.4     4  147.    62  3.69  3.19  20       1     0     4     2\n 9  22.8     4  141.    95  3.92  3.15  22.9     1     0     4     2\n10  19.2     6  168.   123  3.92  3.44  18.3     1     0     4     4\n# ℹ 22 more rows\n\n\n\nmy_lm(mpg ~ ., mtcars)\n\n# A tibble: 11 × 5\n   term        estimate std_error statistics p_value\n   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;\n 1 (Intercept)  12.3      18.7         0.657  0.518 \n 2 cyl          -0.111     1.05       -0.107  0.916 \n 3 disp          0.0133    0.0179      0.747  0.463 \n 4 hp           -0.0215    0.0218     -0.987  0.335 \n 5 drat          0.787     1.64        0.481  0.635 \n 6 wt           -3.72      1.89       -1.96   0.0633\n 7 qsec          0.821     0.731       1.12   0.274 \n 8 vs            0.318     2.10        0.151  0.881 \n 9 am            2.52      2.06        1.23   0.234 \n10 gear          0.655     1.49        0.439  0.665 \n11 carb         -0.199     0.829      -0.241  0.812 \n\n\n\nlm(mpg ~ ., mtcars) %&gt;% \n  broom::tidy()\n\n# A tibble: 11 × 5\n   term        estimate std.error statistic p.value\n   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;\n 1 (Intercept)  12.3      18.7        0.657  0.518 \n 2 cyl          -0.111     1.05      -0.107  0.916 \n 3 disp          0.0133    0.0179     0.747  0.463 \n 4 hp           -0.0215    0.0218    -0.987  0.335 \n 5 drat          0.787     1.64       0.481  0.635 \n 6 wt           -3.72      1.89      -1.96   0.0633\n 7 qsec          0.821     0.731      1.12   0.274 \n 8 vs            0.318     2.10       0.151  0.881 \n 9 am            2.52      2.06       1.23   0.234 \n10 gear          0.655     1.49       0.439  0.665 \n11 carb         -0.199     0.829     -0.241  0.812 \n\n\n这次得到的结果又完全一样。前面t值不同的原因比较复杂，可能是函数运算机制不同。"
  },
  {
    "objectID": "posts/从pdf提取表格/从pdf提取表格.html",
    "href": "posts/从pdf提取表格/从pdf提取表格.html",
    "title": "从pdf提取表格",
    "section": "",
    "text": "library(tidyverse)\nlibrary(pdftools)"
  },
  {
    "objectID": "posts/从pdf读取表格/从pdf读取表格.html",
    "href": "posts/从pdf读取表格/从pdf读取表格.html",
    "title": "从pdf读取表格",
    "section": "",
    "text": "library(tidyverse)\nlibrary(docxtractr)\n\n最近看到烟草局招生，想报个名，结果发现招聘信息表都放在pdf里，不方便做筛选，于是想用R来提取数据框并处理一下。\n\n1 提取pdf中数据框的常见方案\n回顾用R从pdf中读取数据的常见方案及其弊端：\n\n用pdftools读取文本，再整理成数据框：\n\n实际上就是用正则表达式清洗文本数据，步骤比较繁琐。\n表格页数较多或者表格的格式较复杂的时候容易出错。\n\n用tabulizer从pdf中提取数据框：\n\n需要配置java，非常麻烦。\n提取的结果不准确。\n\n连接pdftables调用api：\n\n需要在网站上注册，每次使用还需要输入账号和密码。\n提取的结果不准确。\n\n\n下面这个表格存在单元格内换行的情况，用pdftools根本就无从下手，用tabulizer或pdftables也容易出错。\n\n\n\n\n\n\n\n\n\n\n\n2 用docxtractr提取\n我发现了一个包doxtractr可以很轻松的提取word中的数据，对于一些格式复杂的pdf可以转换成word，然后用doxtractr包读取数据。\n为什么pdf转换成word后就能准确提取表格了呢？我猜测这是因为pdf是一种矢量结构，不具备并不会用code注明哪些元素是表格哪些元素是文字，pdf中的元素只有位置的区别而没有属性的区别。而word会标明哪些元素是表格，就像在编程里声明了表格这种class，因此容易提取。\n将pdf用word打开并另存为word后，用docxtratr包的read_docx()读入\n\ndocs &lt;- read_docx(\"071052144z0f.docx\")\ndocs\n\nWord document [071052144z0f.docx]\n\nTable 1\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 2\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 3\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 4\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 5\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 6\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 7\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 8\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 9\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 10\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 11\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 12\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 13\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 14\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 15\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 16\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 17\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 18\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 19\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 20\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 21\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 22\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 23\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 24\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 25\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 26\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 27\n  total cells: 33\n  row count  : 3\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\n\nNo comments in document\n\n\n可以看到文档中的表格被自动识别，并且推断出的表格的表头都是正确的。\n使用docx_extract_tbl()提取表格\n\ndocx_extract_tbl(docs, tbl_number = 1)\n\n# A tibble: 7 × 11\n  用人单位            具体单位 岗位名称 岗位简介.主要职责描述. 岗位代码 招聘人数\n  &lt;chr&gt;               &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;                  &lt;chr&gt;    &lt;chr&gt;   \n1 河南省烟草专卖局（… 内设机构 经济运…  负责经济运行管理等工…  10101    1       \n2 河南省烟草专卖局（… 内设机构 科技项…  负责科技项目管理等工…  10102    1       \n3 河南省烟草专卖局（… 内设机构 企业法…  负责法治建设等工作。   10103    1       \n4 河南省烟草专卖局（… 内设机构 资金管…  负责会计核算工作；负…  10104    1       \n5 河南省烟草专卖局（… 内设机构 营销管…  负责卷烟营销数据采集…  10105    1       \n6 河南省烟草专卖局（… 内设机构 营销管…  负责卷烟营销数据采集…  10106    1       \n7 河南省烟草专卖局（… 内设机构 综合管…  负责行政后勤管理等工…  10107    1       \n# ℹ 5 more variables: 所需专业名称 &lt;chr&gt;, 学历学位 &lt;chr&gt;, 政治面貌 &lt;chr&gt;,\n#   毕业年限 &lt;chr&gt;, 备注 &lt;chr&gt;\n\n\n这里我们的pdf有27页，每页的表格都是固定的表头，可以用docx_extract_all_tbls()提取全部表格再按行合并。\n\ntbls &lt;- docx_extract_all_tbls(docs)\nrecruitment &lt;- do.call(what = bind_rows, args = tbls)\nrecruitment\n\n# A tibble: 164 × 11\n   用人单位          具体单位 岗位名称  岗位简介.主要职责描述. 岗位代码 招聘人数\n   &lt;chr&gt;             &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;                  &lt;chr&gt;    &lt;chr&gt;   \n 1 河南省烟草专卖局… 内设机构 经济运行… 负责经济运行管理等工…  10101    1       \n 2 河南省烟草专卖局… 内设机构 科技项目… 负责科技项目管理等工…  10102    1       \n 3 河南省烟草专卖局… 内设机构 企业法律… 负责法治建设等工作。   10103    1       \n 4 河南省烟草专卖局… 内设机构 资金管理… 负责会计核算工作；负…  10104    1       \n 5 河南省烟草专卖局… 内设机构 营销管理… 负责卷烟营销数据采集…  10105    1       \n 6 河南省烟草专卖局… 内设机构 营销管理… 负责卷烟营销数据采集…  10106    1       \n 7 河南省烟草专卖局… 内设机构 综合管理… 负责行政后勤管理等工…  10107    1       \n 8 河南省烟草专卖局… 内设机构 网络安全… 负责网络和信息安全等…  10108    1       \n 9 河南省烟草专卖局… 内设机构 质量监督… 负责烟草制品质量监督…  10109    1       \n10 中国烟草河南进出… 内设机构 会计（审… 负责会计核算工作；负…  10110    1       \n# ℹ 154 more rows\n# ℹ 5 more variables: 所需专业名称 &lt;chr&gt;, 学历学位 &lt;chr&gt;, 政治面貌 &lt;chr&gt;,\n#   毕业年限 &lt;chr&gt;, 备注 &lt;chr&gt;\n\n\n数据的提取到这里就完成了，可以进行下一步的分析，或者将数据导出成excel。"
  },
  {
    "objectID": "posts/从pdf读取表格/从pdf读取表格.html#用docxtractr提取",
    "href": "posts/从pdf读取表格/从pdf读取表格.html#用docxtractr提取",
    "title": "从pdf读取表格",
    "section": "1.1 用docxtractr提取",
    "text": "1.1 用docxtractr提取\n我发现了一个包doxtractr可以很轻松的提取word中的数据，对于一些格式复杂的pdf可以转换成word，然后用doxtractr包读取数据。\n为什么pdf转换成word后就能准确提取表格了呢？我猜测这是因为pdf是一种矢量结构，不具备并不会用code注明哪些元素是表格哪些元素是文字，pdf中的元素只有位置的区别而没有属性的区别。而word会标明哪些元素是表格，就像在编程里声明了表格这种class，因此容易提取。\n将pdf用word打开并另存为word后，用docxtratr包的read_docx()读入\n\ndocs &lt;- read_docx(\"071052144z0f.docx\")\ndocs\n\nWord document [071052144z0f.docx]\n\nTable 1\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 2\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 3\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 4\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 5\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 6\n  total cells: 88\n  row count  : 8\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 7\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 8\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 9\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 10\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 11\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 12\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 13\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 14\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 15\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 16\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 17\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 18\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 19\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 20\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 21\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 22\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 23\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 24\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 25\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 26\n  total cells: 77\n  row count  : 7\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\nTable 27\n  total cells: 33\n  row count  : 3\n  uniform    : likely!\n  has header : likely! =&gt; possibly [用人单位, 具体单位, 岗位名称, 岗位简介（主要职责描述）, 岗位代码, 招聘人数, 所需专业名称, 学历学位, 政治面貌, 毕业年限, 备注]\n\n\nNo comments in document\n\n\n可以看到文档中的表格被自动识别，并且推断出的表格的表头都是正确的。\n使用docx_extract_tbl()提取表格\n\ndocx_extract_tbl(docs, tbl_number = 1)\n\n# A tibble: 7 × 11\n  用人单位            具体单位 岗位名称 岗位简介.主要职责描述. 岗位代码 招聘人数\n  &lt;chr&gt;               &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;                  &lt;chr&gt;    &lt;chr&gt;   \n1 河南省烟草专卖局（… 内设机构 经济运…  负责经济运行管理等工…  10101    1       \n2 河南省烟草专卖局（… 内设机构 科技项…  负责科技项目管理等工…  10102    1       \n3 河南省烟草专卖局（… 内设机构 企业法…  负责法治建设等工作。   10103    1       \n4 河南省烟草专卖局（… 内设机构 资金管…  负责会计核算工作；负…  10104    1       \n5 河南省烟草专卖局（… 内设机构 营销管…  负责卷烟营销数据采集…  10105    1       \n6 河南省烟草专卖局（… 内设机构 营销管…  负责卷烟营销数据采集…  10106    1       \n7 河南省烟草专卖局（… 内设机构 综合管…  负责行政后勤管理等工…  10107    1       \n# ℹ 5 more variables: 所需专业名称 &lt;chr&gt;, 学历学位 &lt;chr&gt;, 政治面貌 &lt;chr&gt;,\n#   毕业年限 &lt;chr&gt;, 备注 &lt;chr&gt;\n\n\n这里我们的pdf有27页，每页的表格都是固定的表头，可以用docx_extract_all_tbls()提取全部表格再按行合并。\n\ntbls &lt;- docx_extract_all_tbls(docs)\nrecruitment &lt;- do.call(what = bind_rows, args = tbls)\nrecruitment\n\n# A tibble: 164 × 11\n   用人单位          具体单位 岗位名称  岗位简介.主要职责描述. 岗位代码 招聘人数\n   &lt;chr&gt;             &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt;                  &lt;chr&gt;    &lt;chr&gt;   \n 1 河南省烟草专卖局… 内设机构 经济运行… 负责经济运行管理等工…  10101    1       \n 2 河南省烟草专卖局… 内设机构 科技项目… 负责科技项目管理等工…  10102    1       \n 3 河南省烟草专卖局… 内设机构 企业法律… 负责法治建设等工作。   10103    1       \n 4 河南省烟草专卖局… 内设机构 资金管理… 负责会计核算工作；负…  10104    1       \n 5 河南省烟草专卖局… 内设机构 营销管理… 负责卷烟营销数据采集…  10105    1       \n 6 河南省烟草专卖局… 内设机构 营销管理… 负责卷烟营销数据采集…  10106    1       \n 7 河南省烟草专卖局… 内设机构 综合管理… 负责行政后勤管理等工…  10107    1       \n 8 河南省烟草专卖局… 内设机构 网络安全… 负责网络和信息安全等…  10108    1       \n 9 河南省烟草专卖局… 内设机构 质量监督… 负责烟草制品质量监督…  10109    1       \n10 中国烟草河南进出… 内设机构 会计（审… 负责会计核算工作；负…  10110    1       \n# ℹ 154 more rows\n# ℹ 5 more variables: 所需专业名称 &lt;chr&gt;, 学历学位 &lt;chr&gt;, 政治面貌 &lt;chr&gt;,\n#   毕业年限 &lt;chr&gt;, 备注 &lt;chr&gt;"
  }
]